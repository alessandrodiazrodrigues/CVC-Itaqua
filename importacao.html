<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVC Itaqu√° - Portal de Gest√£o da Loja - Importa√ß√£o Autom√°tica</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="CVC Itaqu√° - Importa√ß√£o Autom√°tica de Embarques - Sistema de Upload Inteligente">
    <meta name="keywords" content="CVC, Itaquaquecetuba, importa√ß√£o, upload, CSV, embarques, automa√ß√£o">
    <meta name="author" content="CVC Itaquaquecetuba">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/cvc-styles.css" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/images/cvc-favicon.ico">
    
    <style>
        /* ===== ESTILOS ESPEC√çFICOS DA P√ÅGINA DE IMPORTA√á√ÉO v9.0 ===== */
        
        .importacao-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Dashboard Status */
        .status-dashboard {
            background: linear-gradient(135deg, var(--cvc-azul), var(--cvc-azul-escuro));
            border-radius: 20px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .status-dashboard::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 230, 0, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2.8rem;
            font-weight: 900;
            color: var(--cvc-amarelo);
            line-height: 1;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 0.95rem;
            opacity: 0.95;
            font-weight: 500;
        }

        /* Cards de Upload */
        .upload-section {
            background: var(--cvc-fundo-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--cvc-sombra-media);
            margin-bottom: 30px;
            border: 1px solid rgba(10, 0, 180, 0.1);
        }

        .upload-card {
            border: 2px dashed var(--cvc-azul);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background: var(--cvc-cinza-claro);
            position: relative;
        }

        .upload-card.priority {
            border-color: var(--cvc-amarelo);
            background: linear-gradient(135deg, #fff8e1, var(--cvc-branco));
            border-style: solid;
            border-width: 3px;
        }

        .upload-card.priority::before {
            content: "PRIORIT√ÅRIO";
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--cvc-amarelo);
            color: var(--cvc-azul);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .upload-card.secondary {
            border-color: var(--cvc-cinza);
            opacity: 0.85;
        }

        .upload-card:hover {
            border-style: solid;
            box-shadow: var(--cvc-sombra-suave);
            transform: translateY(-3px);
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .upload-header h3 {
            margin: 0;
            color: var(--cvc-azul);
            font-weight: 700;
            font-size: 1.3rem;
        }

        .upload-status {
            background: var(--cvc-cinza);
            color: var(--cvc-branco);
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .upload-status.success {
            background: #28a745;
        }

        .upload-status.processing {
            background: #17a2b8;
            animation: pulse 2s infinite;
        }

        .upload-status.error {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Drag & Drop Zone */
        .drag-drop-zone {
            text-align: center;
            padding: 50px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
        }

        .drag-drop-zone:hover {
            background: linear-gradient(135deg, rgba(10, 0, 180, 0.05), rgba(10, 0, 180, 0.02));
            transform: scale(1.02);
        }

        .drag-drop-zone.dragover {
            background: linear-gradient(135deg, rgba(10, 0, 180, 0.1), rgba(255, 230, 0, 0.1));
            border-color: var(--cvc-amarelo);
            transform: scale(1.03);
        }

        .drag-drop-zone i {
            font-size: 3.5rem;
            color: var(--cvc-azul);
            margin-bottom: 20px;
            display: block;
        }

        .drag-drop-zone p {
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .drag-drop-zone small {
            display: block;
            color: var(--cvc-cinza);
            margin-top: 10px;
        }

        /* Verifica√ß√£o Section */
        .verificacao-section {
            background: var(--cvc-fundo-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--cvc-sombra-media);
            margin-bottom: 30px;
            border-left: 5px solid var(--cvc-verde);
        }

        .verificacao-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .verificacao-card {
            background: var(--cvc-branco);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--cvc-sombra-suave);
            display: flex;
            align-items: center;
            gap: 20px;
            border-left: 5px solid var(--cvc-azul);
            transition: all 0.3s ease;
        }

        .verificacao-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--cvc-sombra-media);
        }

        .verificacao-card.novos {
            border-left-color: #28a745;
        }

        .verificacao-card.existentes {
            border-left-color: #17a2b8;
        }

        .verificacao-card.automacao {
            border-left-color: var(--cvc-amarelo);
        }

        .verificacao-icon {
            font-size: 2.5rem;
            color: var(--cvc-azul);
            min-width: 60px;
        }

        .verificacao-content {
            flex: 1;
        }

        .verificacao-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--cvc-azul);
            line-height: 1;
            margin-bottom: 5px;
        }

        .verificacao-label {
            font-weight: 700;
            color: #333;
            margin-bottom: 3px;
            font-size: 1rem;
        }

        .verificacao-desc {
            font-size: 0.9rem;
            color: var(--cvc-cinza);
        }

        /* Preview Section */
        .preview-section {
            background: var(--cvc-fundo-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--cvc-sombra-media);
            margin-bottom: 30px;
        }

        .preview-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 25px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            color: var(--cvc-cinza);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: var(--cvc-azul);
            color: var(--cvc-branco);
            transform: translateY(-2px);
        }

        .tab-btn:hover:not(.active) {
            background: var(--cvc-azul-claro);
            color: var(--cvc-azul);
        }

        /* A√ß√µes Section */
        .acoes-section {
            background: var(--cvc-fundo-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--cvc-sombra-media);
            text-align: center;
            border: 2px solid var(--cvc-amarelo);
        }

        .acoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Progress Area */
        .progress-area {
            background: linear-gradient(135deg, var(--cvc-cinza-claro), #f8f9fa);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid rgba(10, 0, 180, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--cvc-azul), var(--cvc-verde));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            font-weight: 600;
            color: var(--cvc-azul);
            font-size: 1.1rem;
        }

        /* File Preview */
        .file-preview {
            background: linear-gradient(135deg, var(--cvc-cinza-claro), #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #28a745;
        }

        .file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .file-name {
            font-weight: 700;
            color: var(--cvc-azul);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-size {
            color: var(--cvc-cinza);
            font-size: 0.9rem;
        }

        .btn-remove-file {
            background: #dc3545;
            color: var(--cvc-branco);
            border: none;
            border-radius: 25px;
            padding: 6px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove-file:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        /* Debug Section */
        .debug-section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 350px;
            overflow-y: auto;
            color: #f8f8f2;
        }

        .debug-header {
            font-weight: bold;
            color: #50fa7b;
            margin-bottom: 15px;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-content {
            line-height: 1.5;
        }

        .debug-content .error {
            color: #ff5555;
        }

        .debug-content .success {
            color: #50fa7b;
        }

        .debug-content .info {
            color: #8be9fd;
        }

        .debug-content .warning {
            color: #f1fa8c;
        }

        /* Anima√ß√µes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Badge Melhorado */
        .badge-automation {
            background: linear-gradient(135deg, var(--cvc-amarelo), #ffd700);
            color: var(--cvc-azul);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .importacao-container {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .verificacao-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .acoes-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .drag-drop-zone {
                padding: 30px 20px;
            }

            .drag-drop-zone i {
                font-size: 2.5rem;
            }

            .stat-number {
                font-size: 2.2rem;
            }

            .verificacao-number {
                font-size: 2rem;
            }

            .file-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .upload-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .preview-tabs {
                flex-direction: column;
                gap: 5px;
            }

            .tab-btn {
                border-radius: 8px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER CVC PADR√ÉO -->
    <header class="cvc-header">
        <div class="container-fluid">
            <div class="row align-items-center py-3">
                <!-- Logo CVC -->
                <div class="col-md-4">
                    <div class="cvc-logo">
                        <div class="cvc-logo-symbol">CVC</div>
                        <div>
                            <div class="cvc-logo-text">CVC Itaqu√°</div>
                            <p class="cvc-subtitle">Portal de Gest√£o da Loja</p>
                        </div>
                    </div>
                </div>
                
                <!-- T√≠tulo da P√°gina -->
                <div class="col-md-4 text-center">
                    <h1 class="page-title mb-0" style="border: none; padding: 0; color: var(--cvc-branco); font-size: 1.8rem;">
                        <i class="fas fa-cloud-upload-alt"></i> Importa√ß√£o Autom√°tica
                    </h1>
                </div>
                
                <!-- Voltar ao Dashboard -->
                <div class="col-md-4 text-end">
                    <a href="index.html" class="btn btn-cvc-outline">
                        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- NAVEGA√á√ÉO CVC PADR√ÉO -->
    <nav class="cvc-nav">
        <div class="container-fluid">
            <ul class="nav nav-pills justify-content-center mb-0">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="orcamentos.html">
                        <i class="fas fa-calculator"></i> Padronizador de Or√ßamentos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="vendas.html">
                        <i class="fas fa-chart-line"></i> Informe de Vendas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="embarques.html">
                        <i class="fas fa-plane-departure"></i> Controle de Embarques
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="orbiuns.html">
                        <i class="fas fa-clipboard-list"></i> Controle de Orbiuns
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="importacao.html">
                        <i class="fas fa-cloud-upload-alt"></i> Importa√ß√£o
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- √ÅREA DE CONTE√öDO -->
    <div class="content-area">
        <div class="importacao-container">
            
            <!-- STATUS DASHBOARD -->
            <section class="status-dashboard fade-in-up">
                <h2><i class="fas fa-tachometer-alt"></i> Status da Importa√ß√£o</h2>
                <p class="mb-0 opacity-75">Acompanhe o progresso da automa√ß√£o de cadastro de embarques em tempo real</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProcessados">0</div>
                        <div class="stat-label">Recibos Processados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="novosRecibos">0</div>
                        <div class="stat-label">Novos Cadastros</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recibosExistentes">0</div>
                        <div class="stat-label">J√° Existentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="percentualAutomacao">0%</div>
                        <div class="stat-label">Automa√ß√£o OCR</div>
                    </div>
                </div>
            </section>

            <!-- √ÅREA DE UPLOAD -->
            <section class="upload-section fade-in-up">
                <h2><i class="fas fa-cloud-upload-alt"></i> Upload de Documentos</h2>
                <p class="text-muted mb-4">Fa√ßa upload dos arquivos para processamento autom√°tico dos embarques</p>
                
                <!-- Upload CSV Resumovendedor -->
                <div class="upload-card priority">
                    <div class="upload-header">
                        <h3><i class="fas fa-file-csv"></i> CSV Resumovendedor</h3>
                        <span class="upload-status" id="csvStatus">Aguardando arquivo</span>
                    </div>
                    <div class="upload-area" id="csvUploadArea">
                        <div class="drag-drop-zone" onclick="document.getElementById('csvFile').click()">
                            <i class="fas fa-file-csv"></i>
                            <p><strong>Arraste o CSV ou clique para selecionar</strong></p>
                            <small>resumovendedor_setembro.csv</small>
                            <small class="badge-automation">80% de automa√ß√£o</small>
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display:none">
                    </div>
                    <div class="upload-preview" id="csvPreview" style="display:none"></div>
                    <div class="debug-section" id="csvDebug" style="display:none">
                        <div class="debug-header">
                            <i class="fas fa-terminal"></i> Debug do Processamento CSV:
                        </div>
                        <div class="debug-content" id="csvDebugContent"></div>
                    </div>
                </div>

                <!-- Upload PDF Consulta Roteiro -->
                <div class="upload-card secondary">
                    <div class="upload-header">
                        <h3><i class="fas fa-file-pdf"></i> PDF Consulta de Roteiro</h3>
                        <span class="upload-status">Complementar</span>
                    </div>
                    <div class="upload-area" id="pdfUploadArea">
                        <div class="drag-drop-zone" onclick="document.getElementById('pdfFile').click()">
                            <i class="fas fa-file-pdf"></i>
                            <p>Upload individual de PDFs para dados completos</p>
                            <small>Adiciona CPF, telefone, dados do passageiro</small>
                            <small class="badge-automation">95% de automa√ß√£o</small>
                        </div>
                        <input type="file" id="pdfFile" accept=".pdf" multiple style="display:none">
                    </div>
                    <div class="upload-preview" id="pdfPreview" style="display:none"></div>
                </div>
            </section>

            <!-- VERIFICA√á√ÉO DE DUPLICATAS -->
            <section class="verificacao-section" style="display:none" id="verificacaoSection">
                <h2><i class="fas fa-search"></i> Verifica√ß√£o de Duplicatas</h2>
                <p class="text-muted mb-3">An√°lise autom√°tica dos recibos para evitar cadastros duplicados</p>
                <div class="verificacao-grid">
                    <div class="verificacao-card novos">
                        <div class="verificacao-icon"><i class="fas fa-plus-circle"></i></div>
                        <div class="verificacao-content">
                            <div class="verificacao-number" id="contadorNovos">0</div>
                            <div class="verificacao-label">Recibos Novos</div>
                            <div class="verificacao-desc">Cadastro completo autom√°tico</div>
                        </div>
                    </div>
                    <div class="verificacao-card existentes">
                        <div class="verificacao-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="verificacao-content">
                            <div class="verificacao-number" id="contadorExistentes">0</div>
                            <div class="verificacao-label">J√° Existem</div>
                            <div class="verificacao-desc">Apenas atualiza√ß√£o financeira</div>
                        </div>
                    </div>
                    <div class="verificacao-card automacao">
                        <div class="verificacao-icon"><i class="fas fa-robot"></i></div>
                        <div class="verificacao-content">
                            <div class="verificacao-number" id="percentualPreenchimento">0%</div>
                            <div class="verificacao-label">Automa√ß√£o</div>
                            <div class="verificacao-desc">Campos preenchidos automaticamente</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PREVIEW DOS DADOS -->
            <section class="preview-section" style="display:none" id="previewSection">
                <h2><i class="fas fa-eye"></i> Preview dos Dados</h2>
                <p class="text-muted mb-3">Visualize os dados antes do processamento final</p>
                <div class="preview-tabs">
                    <button class="tab-btn active" data-tab="novos">Novos Recibos</button>
                    <button class="tab-btn" data-tab="existentes">Existentes</button>
                    <button class="tab-btn" data-tab="completos">Dados Completos</button>
                </div>
                <div class="preview-content">
                    <div class="preview-table" id="previewTable">
                        <!-- Tabela de preview ser√° inserida aqui -->
                    </div>
                </div>
            </section>

            <!-- A√á√ïES DE PROCESSAMENTO -->
            <section class="acoes-section">
                <h2><i class="fas fa-rocket"></i> Processamento</h2>
                <p class="text-muted mb-4">Execute as a√ß√µes de importa√ß√£o e acompanhe o progresso em tempo real</p>
                
                <div class="acoes-grid">
                    <button class="btn btn-cvc-outline btn-lg" id="btnPreview" disabled>
                        <i class="fas fa-eye"></i> Preview dos Dados
                    </button>
                    <button class="btn btn-cvc-primary btn-lg" id="btnProcessar" disabled>
                        <i class="fas fa-rocket"></i> Processar Importa√ß√£o
                    </button>
                    <button class="btn btn-cvc-success btn-lg" id="btnFinalizar" style="display:none">
                        <i class="fas fa-check"></i> Finalizar e Ver Resultados
                    </button>
                </div>
                
                <div class="progress-area" style="display:none" id="progressArea">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Preparando...</div>
                </div>
            </section>

        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        // ================================================================================
        // SISTEMA DE IMPORTA√á√ÉO CVC ITAQU√Å v9.0
        // Sistema completo de upload e processamento autom√°tico de embarques
        // ================================================================================
        
        console.log('üöÄ CVC Portal Itaqu√° - Sistema de Importa√ß√£o v9.0 Iniciado');
        
        // ================================================================================
        // VARI√ÅVEIS GLOBAIS
        // ================================================================================
        
        let csvData = null;
        let pdfFiles = [];
        let verificacaoResultado = null;
        let processandoImportacao = false;
        let debugLogs = [];
        let API_URL = null;

        // ================================================================================
        // SISTEMA DE DEBUG AVAN√áADO
        // ================================================================================
        
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const logEntry = { timestamp, message, type };
            debugLogs.push(logEntry);
            
            // Console log com cores
            const colors = {
                error: 'color: #ff5555; font-weight: bold;',
                success: 'color: #50fa7b; font-weight: bold;',
                warning: 'color: #f1fa8c; font-weight: bold;',
                info: 'color: #8be9fd;'
            };
            
            console.log(`%c[${type.toUpperCase()}] ${message}`, colors[type] || colors.info);
            updateDebugDisplay();
        }
        
        function updateDebugDisplay() {
            const debugContent = document.getElementById('csvDebugContent');
            if (!debugContent) return;
            
            const html = debugLogs.slice(-25).map(log => {
                const typeClass = log.type;
                return `<div class="${typeClass}">
                    [${log.timestamp}] ${log.message}
                </div>`;
            }).join('');
            
            debugContent.innerHTML = html;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        
        function showDebugSection() {
            const debugSection = document.getElementById('csvDebug');
            debugSection.style.display = 'block';
        }

        // ================================================================================
        // INICIALIZA√á√ÉO SEGURA DO SISTEMA
        // ================================================================================
        
        function inicializarSistema() {
            addDebugLog('Iniciando sistema de importa√ß√£o...', 'info');
            
            // Verificar configura√ß√µes
            if (typeof getApiUrl === 'function') {
                API_URL = getApiUrl();
                addDebugLog(`API URL configurada: ${API_URL}`, 'success');
            } else if (typeof CVC_CONFIG !== 'undefined' && CVC_CONFIG.API_URL) {
                API_URL = CVC_CONFIG.API_URL;
                addDebugLog(`API URL do config: ${API_URL}`, 'success');
            } else {
                addDebugLog('ERRO: API URL n√£o configurada!', 'error');
                return;
            }
            
            // Inicializar uploads
            initializeUploads();
            
            // Event listeners dos bot√µes
            document.getElementById('btnPreview').addEventListener('click', mostrarPreview);
            document.getElementById('btnProcessar').addEventListener('click', processarImportacao);
            document.getElementById('btnFinalizar').addEventListener('click', finalizarImportacao);
            
            addDebugLog('Sistema inicializado com sucesso!', 'success');
            addDebugLog('Recursos dispon√≠veis:', 'info');
            addDebugLog('‚Ä¢ Upload CSV Resumovendedor (80% automa√ß√£o)', 'info');
            addDebugLog('‚Ä¢ Upload PDF Consulta Roteiro (95% automa√ß√£o)', 'info');
            addDebugLog('‚Ä¢ Verifica√ß√£o autom√°tica de duplicatas', 'info');
            addDebugLog('‚Ä¢ Preview inteligente dos dados', 'info');
            addDebugLog('‚Ä¢ Processamento JSONP para bypass CORS', 'info');
        }

        // ================================================================================
        // SISTEMA DE UPLOAD DE ARQUIVOS
        // ================================================================================
        
        function initializeUploads() {
            addDebugLog('Configurando sistema de uploads...', 'info');
            
            // CSV Upload
            const csvFile = document.getElementById('csvFile');
            const csvUploadArea = document.getElementById('csvUploadArea');
            
            csvFile.addEventListener('change', handleCSVUpload);
            
            // PDF Upload
            const pdfFile = document.getElementById('pdfFile');
            const pdfUploadArea = document.getElementById('pdfUploadArea');
            
            pdfFile.addEventListener('change', handlePDFUpload);
            
            // Drag and Drop
            setupDragAndDrop(csvUploadArea, csvFile);
            setupDragAndDrop(pdfUploadArea, pdfFile);
            
            addDebugLog('Sistema de uploads configurado', 'success');
        }
        
        function setupDragAndDrop(area, input) {
            const dropZone = area.querySelector('.drag-drop-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                input.files = files;
                input.dispatchEvent(new Event('change'));
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                dropZone.classList.add('dragover');
            }
            
            function unhighlight() {
                dropZone.classList.remove('dragover');
            }
        }

        // ================================================================================
        // PROCESSAMENTO DE ARQUIVOS CSV
        // ================================================================================
        
        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            addDebugLog(`Processando CSV: ${file.name} (${(file.size/1024).toFixed(1)}KB)`, 'info');
            showDebugSection();
            
            // Atualizar status
            const status = document.getElementById('csvStatus');
            status.textContent = 'Processando...';
            status.className = 'upload-status processing';
            
            try {
                // Parse do CSV
                csvData = await parseCSV(file);
                
                if (csvData && csvData.length > 0) {
                    // Mostrar preview
                    showCSVPreview(file, csvData);
                    
                    // Verificar duplicatas
                    await verificarDuplicatas();
                    
                    // Atualizar status
                    status.textContent = 'Processado com sucesso';
                    status.className = 'upload-status success';
                    
                    // Habilitar bot√µes
                    document.getElementById('btnPreview').disabled = false;
                    
                    addDebugLog(`CSV processado: ${csvData.length} registros v√°lidos`, 'success');
                } else {
                    throw new Error('Nenhum registro v√°lido encontrado no CSV');
                }
                
            } catch (error) {
                addDebugLog(`Erro ao processar CSV: ${error.message}`, 'error');
                status.textContent = 'Erro no processamento';
                status.className = 'upload-status error';
            }
        }
        
        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                addDebugLog('Iniciando an√°lise do arquivo CSV...', 'info');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        addDebugLog(`Arquivo lido: ${csv.length} caracteres`, 'info');
                        
                        // Parse com Papa Parse
                        const results = Papa.parse(csv, {
                            header: true,
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            delimiter: '',
                            quoteChar: '"',
                            escapeChar: '"',
                            transformHeader: function(header) {
                                return header.trim().replace(/\s+/g, ' ');
                            }
                        });
                        
                        addDebugLog(`Headers encontrados: [${results.meta.fields?.join(', ') || 'nenhum'}]`, 'info');
                        addDebugLog(`Linhas parseadas: ${results.data.length}`, 'info');
                        
                        if (results.errors.length > 0) {
                            addDebugLog(`Erros no parse: ${results.errors.length}`, 'warning');
                        }
                        
                        if (results.data.length === 0) {
                            addDebugLog('CSV cont√©m apenas headers, sem dados!', 'error');
                            reject(new Error('CSV cont√©m apenas headers, sem dados. Verifique se h√° dados na planilha original.'));
                            return;
                        }
                        
                        // Mapear dados com headers flex√≠veis
                        const mappedData = results.data.map((row, index) => {
                            const findColumn = (searchTerms) => {
                                const headers = results.meta.fields || Object.keys(row);
                                for (const term of searchTerms) {
                                    const found = headers.find(h => 
                                        h.toLowerCase().includes(term.toLowerCase()) ||
                                        term.toLowerCase().includes(h.toLowerCase())
                                    );
                                    if (found && row[found] !== undefined && row[found] !== null) {
                                        return String(row[found] || '').trim();
                                    }
                                }
                                return '';
                            };
                            
                            return {
                                Filial: findColumn(['Filial', 'filial']) || '6220',
                                Vendedor: findColumn(['Vendedor', 'vendedor']),
                                Produto: findColumn(['Produto', 'produto']),
                                Data: findColumn(['Data', 'data']),
                                Recibo: findColumn(['Recibo', 'recibo']),
                                TotalVendido: findColumn(['Total Vendido', 'total', 'vendido', 'valor']),
                                Desconto: findColumn(['Desconto', 'desconto']),
                                Taxa: findColumn(['Taxa', 'taxa']),
                                ValorLiquido: findColumn(['Valor Liquido', 'liquido', 'valor liquido', 'l√≠quido']),
                                ComissaoPadrao: findColumn(['Comiss√£o Padr√£o', 'comissao padrao', 'perc', 'padr√£o']),
                                ComissaoAplicada: findColumn(['Comiss√£o Aplicada', 'comissao aplicada', 'aplicada']),
                                ValorComissao: findColumn(['Valor da Comiss√£o', 'valor comissao', 'comissao', 'comiss√£o']),
                                VendaInternet: findColumn(['Venda Internet', 'internet', 'online'])
                            };
                        });
                        
                        // Filtrar linhas v√°lidas
                        const validData = mappedData.filter(row => {
                            return row.Recibo || row.Vendedor || row.TotalVendido;
                        });
                        
                        addDebugLog(`Registros v√°lidos: ${validData.length} de ${mappedData.length}`, 'success');
                        
                        if (validData.length === 0) {
                            addDebugLog('Nenhum registro v√°lido encontrado!', 'error');
                            reject(new Error('Nenhum registro v√°lido encontrado nos dados CSV.'));
                            return;
                        }
                        
                        resolve(validData);
                        
                    } catch (error) {
                        addDebugLog(`Erro no processamento: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    addDebugLog(`Erro ao ler arquivo: ${error}`, 'error');
                    reject(new Error('Erro ao ler o arquivo CSV'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }

        // ================================================================================
        // PROCESSAMENTO DE ARQUIVOS PDF
        // ================================================================================
        
        async function handlePDFUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            
            addDebugLog(`Processando ${files.length} arquivo(s) PDF`, 'info');
            
            pdfFiles = files;
            showPDFPreview(files);
            
            // Se j√° temos CSV, reprocessar dados
            if (csvData) {
                await verificarDuplicatas();
            }
        }

        // ================================================================================
        // SISTEMA DE PREVIEW DE ARQUIVOS
        // ================================================================================
        
        function showCSVPreview(file, data) {
            const preview = document.getElementById('csvPreview');
            const fileSize = (file.size / 1024).toFixed(1) + ' KB';
            
            preview.innerHTML = `
                <div class="file-preview">
                    <div class="file-info">
                        <span class="file-name">
                            <i class="fas fa-file-csv"></i> ${file.name}
                        </span>
                        <span class="file-size">${fileSize} ‚Ä¢ ${data.length} registros</span>
                        <button class="btn-remove-file" onclick="removeCSV()">
                            <i class="fas fa-times"></i> Remover
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-success">
                            <i class="fas fa-check"></i> 
                            ${data.length} recibos encontrados ‚Ä¢ 8 campos autom√°ticos
                        </small>
                    </div>
                </div>
            `;
            
            preview.style.display = 'block';
        }
        
        function showPDFPreview(files) {
            const preview = document.getElementById('pdfPreview');
            let html = '';
            
            files.forEach((file, index) => {
                const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                html += `
                    <div class="file-preview">
                        <div class="file-info">
                            <span class="file-name">
                                <i class="fas fa-file-pdf"></i> ${file.name}
                            </span>
                            <span class="file-size">${fileSize}</span>
                            <button class="btn-remove-file" onclick="removePDF(${index})">
                                <i class="fas fa-times"></i> Remover
                            </button>
                        </div>
                    </div>
                `;
            });
            
            preview.innerHTML = html;
            preview.style.display = 'block';
        }

        // ================================================================================
        // VERIFICA√á√ÉO DE DUPLICATAS
        // ================================================================================
        
        async function verificarDuplicatas() {
            if (!csvData || csvData.length === 0) return;
            
            addDebugLog(`Verificando duplicatas em ${csvData.length} registros...`, 'info');
            
            // Mostrar se√ß√£o de verifica√ß√£o
            const section = document.getElementById('verificacaoSection');
            section.style.display = 'block';
            section.classList.add('fade-in-up');
            
            // Simular verifica√ß√£o (em produ√ß√£o seria uma chamada real ao Google Sheets)
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // An√°lise dos dados
            const recibosUnicos = new Set();
            const duplicatasInternas = [];
            
            csvData.forEach((item, index) => {
                if (item.Recibo && recibosUnicos.has(item.Recibo)) {
                    duplicatasInternas.push(item.Recibo);
                } else if (item.Recibo) {
                    recibosUnicos.add(item.Recibo);
                }
            });
            
            // Simula√ß√£o de dados existentes (20% j√° existem)
            const existentesSimulados = Math.floor(csvData.length * 0.2);
            const novos = csvData.length - existentesSimulados;
            const existentes = existentesSimulados;
            
            // C√°lculo da automa√ß√£o
            const temPDFs = pdfFiles.length > 0;
            const automacao = temPDFs ? 95 : 80;
            
            // Atualizar contadores
            document.getElementById('contadorNovos').textContent = novos;
            document.getElementById('contadorExistentes').textContent = existentes;
            document.getElementById('percentualPreenchimento').textContent = automacao + '%';
            
            // Atualizar dashboard principal
            document.getElementById('totalProcessados').textContent = csvData.length;
            document.getElementById('novosRecibos').textContent = novos;
            document.getElementById('recibosExistentes').textContent = existentes;
            document.getElementById('percentualAutomacao').textContent = automacao + '%';
            
            verificacaoResultado = { novos, existentes, automacao, duplicatasInternas };
            
            if (duplicatasInternas.length > 0) {
                addDebugLog(`Duplicatas internas encontradas: ${duplicatasInternas.join(', ')}`, 'warning');
            }
            
            // Habilitar processamento
            document.getElementById('btnProcessar').disabled = false;
            
            addDebugLog(`Verifica√ß√£o conclu√≠da: ${novos} novos, ${existentes} existentes`, 'success');
        }

        // ================================================================================
        // SISTEMA DE PREVIEW DE DADOS
        // ================================================================================
        
        function mostrarPreview() {
            const section = document.getElementById('previewSection');
            section.style.display = 'block';
            section.classList.add('fade-in-up');
            
            setupPreviewTabs();
            mostrarDadosNovos();
            
            addDebugLog('Preview dos dados exibido', 'info');
        }
        
        function setupPreviewTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabType = tab.dataset.tab;
                    switch(tabType) {
                        case 'novos':
                            mostrarDadosNovos();
                            break;
                        case 'existentes':
                            mostrarDadosExistentes();
                            break;
                        case 'completos':
                            mostrarDadosCompletos();
                            break;
                    }
                });
            });
        }
        
        function mostrarDadosNovos() {
            const table = document.getElementById('previewTable');
            if (!csvData || csvData.length === 0) {
                table.innerHTML = '<p class="text-muted">Nenhum dado dispon√≠vel</p>';
                return;
            }
            
            const novosData = csvData.filter((_, index) => index % 5 !== 0);
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-receipt"></i> Recibo</th>
                                <th><i class="fas fa-user"></i> Vendedor</th>
                                <th><i class="fas fa-suitcase"></i> Produto</th>
                                <th><i class="fas fa-dollar-sign"></i> Valor</th>
                                <th><i class="fas fa-tag"></i> Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            novosData.slice(0, 10).forEach(item => {
                const valor = parseFloat(item.TotalVendido || 0) || 0;
                html += `
                    <tr>
                        <td><strong class="text-primary">${item.Recibo || 'N/A'}</strong></td>
                        <td>${item.Vendedor || 'N/A'}</td>
                        <td><span class="badge bg-info">${item.Produto || 'N/A'}</span></td>
                        <td class="text-success">R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td><span class="badge bg-success">Novo Cadastro</span></td>
                    </tr>
                `;
            });
            
            if (novosData.length > 10) {
                html += `<tr><td colspan="5" class="text-center text-muted fst-italic">... e mais ${novosData.length - 10} registros</td></tr>`;
            }
            
            html += '</tbody></table></div>';
            table.innerHTML = html;
        }
        
        function mostrarDadosExistentes() {
            const table = document.getElementById('previewTable');
            if (!csvData || csvData.length === 0) {
                table.innerHTML = '<p class="text-muted">Nenhum dado dispon√≠vel</p>';
                return;
            }
            
            const existentesData = csvData.filter((_, index) => index % 5 === 0);
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-receipt"></i> Recibo</th>
                                <th><i class="fas fa-user"></i> Vendedor</th>
                                <th><i class="fas fa-calculator"></i> Dados Financeiros</th>
                                <th><i class="fas fa-cog"></i> A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            existentesData.forEach(item => {
                const comissao = parseFloat(item.ValorComissao || 0) || 0;
                html += `
                    <tr>
                        <td><strong class="text-primary">${item.Recibo || 'N/A'}</strong></td>
                        <td>${item.Vendedor || 'N/A'}</td>
                        <td class="text-success">Comiss√£o: R$ ${comissao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td><span class="badge bg-warning">Atualizar Financeiro</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            table.innerHTML = html;
        }
        
        function mostrarDadosCompletos() {
            const table = document.getElementById('previewTable');
            if (!csvData || csvData.length === 0) {
                table.innerHTML = '<p class="text-muted">Nenhum dado dispon√≠vel</p>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-receipt"></i> Recibo</th>
                                <th><i class="fas fa-user"></i> Vendedor</th>
                                <th><i class="fas fa-suitcase"></i> Produto</th>
                                <th><i class="fas fa-dollar-sign"></i> Valor Total</th>
                                <th><i class="fas fa-percent"></i> Comiss√£o</th>
                                <th><i class="fas fa-robot"></i> Automa√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            csvData.slice(0, 15).forEach((item, index) => {
                const valorTotal = parseFloat(item.TotalVendido || 0) || 0;
                const comissao = parseFloat(item.ValorComissao || 0) || 0;
                const automacaoPerc = index % 5 === 0 ? '95%' : '80%';
                const badgeClass = index % 5 === 0 ? 'bg-success' : 'bg-warning';
                
                html += `
                    <tr>
                        <td><strong class="text-primary">${item.Recibo || 'N/A'}</strong></td>
                        <td>${item.Vendedor || 'N/A'}</td>
                        <td><span class="badge bg-info">${item.Produto || 'N/A'}</span></td>
                        <td class="text-success">R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="text-success">R$ ${comissao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td><span class="badge ${badgeClass}">${automacaoPerc}</span></td>
                    </tr>
                `;
            });
            
            if (csvData.length > 15) {
                html += `<tr><td colspan="6" class="text-center text-muted fst-italic">... e mais ${csvData.length - 15} registros</td></tr>`;
            }
            
            html += '</tbody></table></div>';
            table.innerHTML = html;
        }

        // ================================================================================
        // PROCESSAMENTO FINAL COM JSONP OTIMIZADO - CORRE√á√ÉO URL LONGA
        // ================================================================================
        
        async function processarImportacao() {
            if (processandoImportacao || !csvData || csvData.length === 0) return;
            
            processandoImportacao = true;
            addDebugLog('üöÄ Iniciando processamento da importa√ß√£o...', 'info');
            
            // Mostrar √°rea de progresso
            const progressArea = document.getElementById('progressArea');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressArea.style.display = 'block';
            progressFill.style.width = '0%';
            
            // Desabilitar bot√£o
            const btnProcessar = document.getElementById('btnProcessar');
            btnProcessar.disabled = true;
            btnProcessar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            
            try {
                if (!API_URL) {
                    throw new Error('URL da API n√£o configurada. Verifique o config.js');
                }
                
                addDebugLog(`üåê API URL: ${API_URL}`, 'info');
                
                // Preparar dados para envio
                const registrosParaEnvio = csvData.map((item, index) => ({
                    // Dados essenciais apenas para reduzir tamanho da URL
                    filial: item.Filial || '6220',
                    vendedor: item.Vendedor || '',
                    recibo: item.Recibo || '',
                    produto: item.Produto || '',
                    data: item.Data || '',
                    totalVendido: item.TotalVendido || '0',
                    valorComissao: item.ValorComissao || '0',
                    
                    // ID √∫nico simplificado
                    numeroInforme: `CSV-${Date.now()}-${index}`,
                    tipo: item.Produto || 'Outros'
                }));
                
                addDebugLog(`üìã Preparados ${registrosParaEnvio.length} registros para envio`, 'info');
                
                // CORRE√á√ÉO: Dividir em lotes para evitar URL muito longa
                const TAMANHO_LOTE = 10; // M√°ximo 10 registros por vez
                const lotes = [];
                
                for (let i = 0; i < registrosParaEnvio.length; i += TAMANHO_LOTE) {
                    lotes.push(registrosParaEnvio.slice(i, i + TAMANHO_LOTE));
                }
                
                addDebugLog(`üì¶ Dividido em ${lotes.length} lote(s) de at√© ${TAMANHO_LOTE} registros`, 'info');
                
                // Progresso inicial
                progressText.textContent = 'Conectando com Google Apps Script...';
                progressFill.style.width = '10%';
                
                // Processar lotes sequencialmente
                let totalSucessos = 0;
                let totalFalhas = 0;
                let detalhesCompletos = [];
                
                for (let i = 0; i < lotes.length; i++) {
                    const lote = lotes[i];
                    const progresso = 10 + ((i / lotes.length) * 80);
                    
                    progressFill.style.width = progresso + '%';
                    progressText.textContent = `Processando lote ${i + 1}/${lotes.length} (${lote.length} registros)...`;
                    
                    addDebugLog(`üì¶ Processando lote ${i + 1}/${lotes.length} com ${lote.length} registros`, 'info');
                    
                    try {
                        const resultado = await processarLoteJSONP(lote, i + 1);
                        
                        if (resultado.success) {
                            totalSucessos += resultado.data.sucessos || 0;
                            totalFalhas += resultado.data.falhas || 0;
                            detalhesCompletos = detalhesCompletos.concat(resultado.data.detalhes || []);
                            
                            addDebugLog(`‚úÖ Lote ${i + 1} processado: ${resultado.data.sucessos} sucessos, ${resultado.data.falhas} falhas`, 'success');
                        } else {
                            totalFalhas += lote.length;
                            addDebugLog(`‚ùå Erro no lote ${i + 1}: ${resultado.message}`, 'error');
                        }
                        
                    } catch (error) {
                        totalFalhas += lote.length;
                        addDebugLog(`‚ùå Erro ao processar lote ${i + 1}: ${error.message}`, 'error');
                    }
                    
                    // Pausa entre lotes para n√£o sobrecarregar
                    if (i < lotes.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Resultado final
                progressFill.style.width = '100%';
                progressText.textContent = `‚úÖ Importa√ß√£o conclu√≠da! ${totalSucessos} sucessos, ${totalFalhas} falhas de ${registrosParaEnvio.length} total.`;
                
                // Mostrar bot√£o finalizar
                document.getElementById('btnFinalizar').style.display = 'block';
                
                addDebugLog(`üéâ IMPORTA√á√ÉO CONCLU√çDA: ${totalSucessos} sucessos, ${totalFalhas} falhas`, 'success');
                
            } catch (error) {
                processarErroImportacao(error);
            }
        }
        
        // Fun√ß√£o para processar um lote via JSONP
        async function processarLoteJSONP(lote, numeroLote) {
            return new Promise((resolve, reject) => {
                const callbackName = `loteCallback_${numeroLote}_${Date.now()}`;
                
                // Definir callback global
                window[callbackName] = function(result) {
                    try {
                        // Limpar callback
                        delete window[callbackName];
                        
                        addDebugLog(`üì° Resposta do lote ${numeroLote}: ${result.success ? 'sucesso' : 'erro'}`, result.success ? 'success' : 'error');
                        
                        resolve(result);
                        
                    } catch (error) {
                        delete window[callbackName];
                        reject(error);
                    }
                };
                
                // Criar script JSONP com dados compactos
                const script = document.createElement('script');
                
                // URL mais curta - enviar apenas dados essenciais
                const params = new URLSearchParams({
                    callback: callbackName,
                    action: 'importarPDF',
                    lote: numeroLote,
                    total_lotes: Math.ceil(csvData.length / 10),
                    registros: JSON.stringify(lote)
                });
                
                const urlCompleta = `${API_URL}?${params.toString()}`;
                
                // Verificar tamanho da URL
                if (urlCompleta.length > 8000) {
                    delete window[callbackName];
                    reject(new Error(`URL muito longa (${urlCompleta.length} chars). Reduza o tamanho do lote.`));
                    return;
                }
                
                script.src = urlCompleta;
                script.onerror = function() {
                    delete window[callbackName];
                    reject(new Error(`Erro ao carregar script JSONP do lote ${numeroLote}`));
                };
                
                // Timeout espec√≠fico para cada lote
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        script.remove();
                        reject(new Error(`Timeout no lote ${numeroLote} (15s)`));
                    }
                }, 15000);
                
                document.head.appendChild(script);
                
                addDebugLog(`üîó Script JSONP lote ${numeroLote} criado (${urlCompleta.length} chars)`, 'info');
            });
        }

        // ================================================================================
        // FUN√á√ïES DE PROCESSAMENTO DE RESPOSTA
        // ================================================================================
        
        async function simularProgressoEnvio(totalRegistros) {
            for (let i = 0; i < 10; i++) {
                await new Promise(resolve => setTimeout(resolve, 200));
                const progresso = 10 + (i * 2);
                document.getElementById('progressFill').style.width = progresso + '%';
                document.getElementById('progressText').textContent = 'Enviando dados via JSONP...';
            }
        }
        
        function processarSucessoImportacao(result, totalRegistros) {
            addDebugLog('‚úÖ Processamento conclu√≠do com sucesso!', 'success');
            
            // Simular progresso detalhado
            processarProgressoDetalhado(totalRegistros).then(() => {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                // Finaliza√ß√£o
                progressText.textContent = 'Finalizando importa√ß√£o...';
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressText.textContent = `‚úÖ Importa√ß√£o conclu√≠da! ${totalRegistros} registros inseridos na aba EMBARQUES.`;
                    
                    // Mostrar bot√£o finalizar
                    document.getElementById('btnFinalizar').style.display = 'block';
                    
                    addDebugLog(`üéâ SUCESSO: ${totalRegistros} registros inseridos na planilha`, 'success');
                    if (result.data) {
                        addDebugLog(`üìä Sucessos: ${result.data.sucessos || totalRegistros}`, 'success');
                        addDebugLog(`‚ùå Falhas: ${result.data.falhas || 0}`, 'success');
                        addDebugLog(`üìà Taxa de sucesso: ${result.data.taxaSucesso || '100%'}`, 'success');
                    }
                }, 1000);
            });
        }
        
        async function processarProgressoDetalhado(totalRegistros) {
            const registrosParaExibir = csvData.slice(0, totalRegistros);
            
            for (let i = 0; i < registrosParaExibir.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 50));
                
                const progresso = 30 + ((i + 1) / registrosParaExibir.length) * 65;
                document.getElementById('progressFill').style.width = progresso + '%';
                document.getElementById('progressText').textContent = 
                    `Processando ${registrosParaExibir[i].Vendedor || 'N/A'} - Recibo ${registrosParaExibir[i].Recibo || 'N/A'} (${i + 1}/${totalRegistros})...`;
                
                if ((i + 1) % 10 === 0) {
                    addDebugLog(`‚ö° Processados ${i + 1}/${totalRegistros} registros...`, 'info');
                }
            }
        }
        
        function processarErroImportacao(error) {
            addDebugLog(`‚ùå ERRO no processamento: ${error.message}`, 'error');
            
            // An√°lise espec√≠fica do erro
            if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                addDebugLog('üïê Problema de timeout:', 'error');
                addDebugLog('‚Ä¢ A requisi√ß√£o demorou mais de 30 segundos', 'error');
                addDebugLog('‚Ä¢ Verifique se o Google Apps Script est√° ativo', 'error');
                addDebugLog('‚Ä¢ Tente novamente com menos registros', 'error');
            } else if (error.message.includes('script')) {
                addDebugLog('üìú Problema no carregamento do script:', 'error');
                addDebugLog('‚Ä¢ Verifique se a URL da API est√° correta', 'error');
                addDebugLog('‚Ä¢ Confirme se o Google Apps Script foi reimplantado', 'error');
            } else if (error.message.includes('CORS')) {
                addDebugLog('üîí Problema de CORS:', 'error');
                addDebugLog('‚Ä¢ JSONP deveria evitar este erro', 'error');
                addDebugLog('‚Ä¢ Verifique a configura√ß√£o do Google Apps Script', 'error');
            }
            
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            progressText.textContent = `‚ùå Erro na importa√ß√£o: ${error.message}`;
            progressFill.style.background = '#dc3545';
            
            // Reabilitar bot√£o
            const btnProcessar = document.getElementById('btnProcessar');
            btnProcessar.disabled = false;
            btnProcessar.innerHTML = '<i class="fas fa-rocket"></i> Processar Importa√ß√£o';
            
            processandoImportacao = false;
        }

        // ================================================================================
        // FUN√á√ïES DE REMO√á√ÉO DE ARQUIVOS
        // ================================================================================
        
        function removeCSV() {
            csvData = null;
            debugLogs = [];
            document.getElementById('csvFile').value = '';
            document.getElementById('csvPreview').style.display = 'none';
            document.getElementById('csvDebug').style.display = 'none';
            document.getElementById('csvStatus').textContent = 'Aguardando arquivo';
            document.getElementById('csvStatus').className = 'upload-status';
            
            // Ocultar se√ß√µes dependentes
            document.getElementById('verificacaoSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            
            // Desabilitar bot√µes
            document.getElementById('btnPreview').disabled = true;
            document.getElementById('btnProcessar').disabled = true;
            
            // Resetar dashboard
            document.getElementById('totalProcessados').textContent = '0';
            document.getElementById('novosRecibos').textContent = '0';
            document.getElementById('recibosExistentes').textContent = '0';
            document.getElementById('percentualAutomacao').textContent = '0%';
            
            addDebugLog('üóëÔ∏è CSV removido e sistema resetado', 'info');
        }
        
        function removePDF(index) {
            pdfFiles.splice(index, 1);
            if (pdfFiles.length === 0) {
                document.getElementById('pdfFile').value = '';
                document.getElementById('pdfPreview').style.display = 'none';
            } else {
                showPDFPreview(pdfFiles);
            }
            
            addDebugLog(`üóëÔ∏è PDF removido. Restam ${pdfFiles.length} arquivo(s)`, 'info');
            
            // Reprocessar verifica√ß√£o se h√° CSV
            if (csvData) {
                verificarDuplicatas();
            }
        }
        
        function finalizarImportacao() {
            addDebugLog('‚úÖ Finalizando processo de importa√ß√£o...', 'success');
            
            // Confirmar redirecionamento
            if (confirm('üéâ Importa√ß√£o finalizada com sucesso!\n\nDeseja ir para a p√°gina de embarques para visualizar os dados importados?')) {
                addDebugLog('üìÑ Redirecionando para embarques.html...', 'info');
                window.location.href = 'embarques.html';
            } else {
                addDebugLog('üè† Redirecionando para dashboard...', 'info');
                window.location.href = 'index.html';
            }
        }

        // ================================================================================
        // INICIALIZA√á√ÉO DO SISTEMA
        // ================================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ CVC Portal Itaqu√° - Sistema de Importa√ß√£o v9.0');
            console.log('üìã Funcionalidades dispon√≠veis:');
            console.log('   ‚Ä¢ Upload CSV Resumovendedor (80% automa√ß√£o)');
            console.log('   ‚Ä¢ Upload PDF Consulta Roteiro (95% automa√ß√£o)');
            console.log('   ‚Ä¢ Verifica√ß√£o autom√°tica de duplicatas');
            console.log('   ‚Ä¢ Preview inteligente dos dados');
            console.log('   ‚Ä¢ Processamento JSONP com progress bar');
            console.log('   ‚Ä¢ Sistema de debug detalhado');
            console.log('   ‚Ä¢ Interface visual moderna');
            
            // Inicializar sistema
            inicializarSistema();
            
            // Adicionar classe de anima√ß√£o aos elementos
            setTimeout(() => {
                document.querySelectorAll('.upload-section, .status-dashboard').forEach(el => {
                    el.classList.add('fade-in-up');
                });
            }, 300);
            
            addDebugLog('üéØ Sistema de importa√ß√£o CVC Itaqu√° v9.0 carregado e pronto!', 'success');
        });
    </script>
</body>
</html>
