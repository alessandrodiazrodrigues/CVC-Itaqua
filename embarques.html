<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVC Portal Itaquá - Controle de Embarques</title>
    
    <!-- Meta Tags Conforme Manual CVC -->
    <meta name="description" content="CVC Portal Itaquá - Sistema Integrado de Gestão para a filial de Itaquaquecetuba">
    <meta name="keywords" content="CVC, Itaquaquecetuba, gestão, viagens, turismo, sistema, embarques">
    <meta name="author" content="CVC Itaquaquecetuba">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="CVC Portal Itaquá - Controle de Embarques">
    <meta property="og:description" content="Sistema de controle de embarques da CVC Itaquaquecetuba">
    <meta property="og:image" content="assets/images/cvc-logo.png">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="assets/images/cvc-favicon.ico">
    <link rel="apple-touch-icon" href="assets/images/cvc-apple-icon.png">
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/cvc-styles.css" rel="stylesheet">
    
    <!-- Configuração -->
    <script src="config.js"></script>
    
    <style>
        /* ================================================================================
         * ESTILOS ESPECÍFICOS PARA EMBARQUES v12.0 - DASHBOARDS TEMPORAIS
         * ================================================================================ */
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--cvc-sombra-forte);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1400px;
            overflow: hidden;
        }
        
        .content-section {
            padding: 30px;
        }
        
        /* DASHBOARDS */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .dashboard-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 600px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--cvc-azul-principal);
        }
        
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--cvc-azul-principal);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dashboard-counter {
            background: var(--cvc-azul-principal);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* CARDS DE EMBARQUES */
        .embarque-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .embarque-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        /* PRIORIDADES */
        .priority-ATRASADO {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff, #ffebee);
        }
        
        .priority-URGENTE {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff, #fff8e7);
        }
        
        .priority-PROXIMO {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff, #fffbf0);
        }
        
        .priority-NORMAL {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #fff, #f0fff4);
        }
        
        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .priority-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-badge.ATRASADO {
            background: #dc3545;
            color: white;
        }
        
        .priority-badge.URGENTE {
            background: #fd7e14;
            color: white;
        }
        
        .priority-badge.PROXIMO {
            background: #ffc107;
            color: #000;
        }
        
        .priority-badge.NORMAL {
            background: #28a745;
            color: white;
        }
        
        .days-remaining {
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
        }
        
        .card-info {
            margin: 8px 0;
        }
        
        .card-info strong {
            color: var(--cvc-azul-principal);
        }
        
        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }
        
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-conferencia {
            background: var(--cvc-azul-principal);
            color: white;
        }
        
        .btn-checkin {
            background: var(--cvc-laranja);
            color: white;
        }
        
        .btn-pos-venda {
            background: var(--cvc-verde);
            color: white;
        }
        
        .btn-action:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        
        /* CONTROLES SUPERIORES */
        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: bold;
            color: var(--cvc-azul-principal);
            font-size: 0.9rem;
        }
        
        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* STATUS E MÉTRICAS */
        .status-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        .status-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: space-between;
            }
            
            .status-section {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* MODAL ESTILOS */
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: var(--cvc-azul-principal);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .form-floating label {
            color: #666;
        }
        
        /* SUCCESS/ERROR ALERTS */
        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 12px 20px;
            margin-bottom: 15px;
        }
        
        .alert-success-custom {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }
        
        .alert-danger-custom {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }
    </style>
</head>
<body class="cvc-background">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="loading-spinner"></div>
            <div class="mt-3">Carregando embarques v12.0...</div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="main-container">
            <!-- Header CVC -->
            <header class="cvc-header">
                <div class="container-fluid">
                    <div class="row align-items-center py-3">
                        <div class="col-md-4">
                            <div class="cvc-logo">
                                <div class="cvc-logo-symbol">CVC</div>
                                <div>
                                    <div class="cvc-logo-text">CVC Portal Itaquá</div>
                                    <p class="cvc-subtitle">Controle de Embarques v12.0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-center">
                            <h1 class="cvc-page-title">Controle de Embarques</h1>
                            <p class="cvc-subtitle-page">Conferências • Check-ins • Pós-vendas</p>
                        </div>
                        
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-light btn-sm me-2" onclick="voltarDashboard()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-light btn-sm me-2" onclick="recarregarEmbarques()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="testarConectividade()">
                                <i class="fas fa-wifi"></i> Testar API
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Conteúdo Principal -->
            <main class="content-section">
                <!-- Status e Métricas -->
                <div class="status-section">
                    <div class="status-info">
                        <div class="status-light"></div>
                        <span><strong>Sistema Online</strong> | Última atualização: <span id="ultimaAtualizacao">Carregando...</span></span>
                    </div>
                    <div class="auto-refresh">
                        <i class="fas fa-clock"></i>
                        <span>Auto-refresh: 5min</span>
                    </div>
                </div>

                <!-- Controles e Filtros -->
                <div class="controls-section">
                    <div class="filter-group">
                        <label for="filtroVendedor">Vendedor:</label>
                        <select class="form-select" id="filtroVendedor" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filtroPrioridade">Prioridade:</label>
                        <select class="form-select" id="filtroPrioridade" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="ATRASADO">Atrasados</option>
                            <option value="URGENTE">Urgentes</option>
                            <option value="PROXIMO">Próximos</option>
                            <option value="NORMAL">Normais</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="buscaCliente">Cliente:</label>
                        <input type="text" class="form-control" id="buscaCliente" placeholder="Nome ou CPF" 
                               onkeyup="aplicarFiltros()" style="width: 200px;">
                    </div>
                    
                    <div class="filter-group ms-auto">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportarRelatorio()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Alert para mensagens -->
                <div id="alertContainer"></div>

                <!-- Dashboards dos Embarques -->
                <div class="dashboard-container" id="dashboardContainer">
                    <!-- Dashboard de Conferências -->
                    <div class="dashboard-section" id="conferenciasSection">
                        <div class="dashboard-header">
                            <div class="dashboard-title">
                                <i class="fas fa-clipboard-check"></i>
                                <span>Conferências</span>
                            </div>
                            <div class="dashboard-counter" id="contadorConferencias">0</div>
                        </div>
                        <div class="dashboard-content" id="conferenciasContent">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-check"></i>
                                <p>Carregando conferências...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard de Check-ins -->
                    <div class="dashboard-section" id="checkinsSection">
                        <div class="dashboard-header">
                            <div class="dashboard-title">
                                <i class="fas fa-plane-departure"></i>
                                <span>Check-ins</span>
                            </div>
                            <div class="dashboard-counter" id="contadorCheckins">0</div>
                        </div>
                        <div class="dashboard-content" id="checkinsContent">
                            <div class="empty-state">
                                <i class="fas fa-plane-departure"></i>
                                <p>Carregando check-ins...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard de Pós-vendas -->
                    <div class="dashboard-section" id="posVendasSection">
                        <div class="dashboard-header">
                            <div class="dashboard-title">
                                <i class="fas fa-star"></i>
                                <span>Pós-vendas</span>
                            </div>
                            <div class="dashboard-counter" id="contadorPosVendas">0</div>
                        </div>
                        <div class="dashboard-content" id="posVendasContent">
                            <div class="empty-state">
                                <i class="fas fa-star"></i>
                                <p>Carregando pós-vendas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Conferência -->
    <div class="modal fade" id="modalConferencia" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Confirmar Conferência
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="conferencia-info"></div>
                    <p class="text-muted mt-3">Esta ação irá marcar todos os voos deste informe como conferidos.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="salvarEdicoes('conferencia')">
                        <i class="fas fa-save"></i> Salvar Edições
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmarConferencia()">
                        <i class="fas fa-check"></i> Conferir Informe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Check-in -->
    <div class="modal fade" id="modalCheckin" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plane-departure me-2"></i>
                        Confirmar Check-in
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="checkin-info"></div>
                    <p class="text-muted mt-3">Esta ação irá marcar este voo específico como check-in realizado.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="salvarEdicoes('checkin')">
                        <i class="fas fa-save"></i> Salvar Edições
                    </button>
                    <button type="button" class="btn btn-warning" onclick="confirmarCheckin()">
                        <i class="fas fa-check"></i> Fazer Check-in
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pós-venda -->
    <div class="modal fade" id="modalPosVenda" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-star me-2"></i>
                        Pós-venda
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pos-venda-info" class="mb-3"></div>
                    
                    <form id="formPosVenda">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <textarea class="form-control" id="observacoes" style="height: 100px"></textarea>
                                    <label for="observacoes">Observações da Viagem</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="grupoOfertas">
                                        <option value="">Selecione...</option>
                                        <option value="Sim">Sim</option>
                                        <option value="Não">Não</option>
                                    </select>
                                    <label for="grupoOfertas">Grupo Ofertas WhatsApp</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="postouInsta">
                                        <option value="">Selecione...</option>
                                        <option value="Sim">Sim</option>
                                        <option value="Não">Não</option>
                                    </select>
                                    <label for="postouInsta">Postou no Instagram</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="avaliacaoGoogle">
                                        <option value="">Selecione...</option>
                                        <option value="Solicitado">Solicitado</option>
                                        <option value="Recusou">Recusou</option>
                                        <option value="Já tinha">Já tinha</option>
                                    </select>
                                    <label for="avaliacaoGoogle">Avaliação Google</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="sac">
                                        <option value="">Selecione...</option>
                                        <option value="Sim">Sim</option>
                                        <option value="Não">Não</option>
                                    </select>
                                    <label for="sac">Teve algum problema (SAC)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="numeroSAC">
                                    <label for="numeroSAC">Número do SAC (se aplicável)</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="confirmarPosVenda()">
                        <i class="fas fa-check"></i> Confirmar Pós-venda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ================================================================================
        // CVC PORTAL ITAQUÁ - EMBARQUES v12.0 - SISTEMA DE DASHBOARDS TEMPORAIS
        // ================================================================================
        
        // Variáveis globais
        let dadosEmbarques = [];
        let dadosFiltrados = {
            conferencias: [],
            checkins: [],
            posVendas: []
        };
        let filtrosAtivos = {
            vendedor: '',
            prioridade: '',
            cliente: ''
        };
        
        // Dados temporários para modais
        let modalData = {};
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 CVC Portal Itaquá - Embarques v12.0 iniciando...');
            inicializarSistema();
        });
        
        async function inicializarSistema() {
            try {
                console.log('🚀 CVC Portal Itaquá - Embarques v12.0 iniciando...');
                console.log('🔧 API URL:', CVC_CONFIG.API_URL);
                console.log('🏪 Filial:', CVC_CONFIG.FILIAL_PADRAO);
                
                mostrarLoading(true);
                
                // Verificar se config está carregado
                if (typeof CVC_CONFIG === 'undefined' || !CVC_CONFIG.API_URL) {
                    throw new Error('Configuração CVC_CONFIG não encontrada. Verifique se config.js está carregado.');
                }
                
                // Carregar vendedores no filtro
                await carregarVendedores();
                console.log('✅ Vendedores carregados');
                
                // Carregar dados dos embarques
                await carregarEmbarques();
                console.log('✅ Embarques carregados');
                
                // Configurar auto-refresh
                configurarAutoRefresh();
                console.log('✅ Auto-refresh configurado');
                
                mostrarLoading(false);
                console.log('✅ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                mostrarAlerta('Erro ao carregar o sistema: ' + error.message, 'danger');
                mostrarLoading(false);
                
                // Mostrar informações de debug
                console.error('🔍 Debug Info:');
                console.error('- CVC_CONFIG existe:', typeof CVC_CONFIG !== 'undefined');
                console.error('- API_URL:', typeof CVC_CONFIG !== 'undefined' ? CVC_CONFIG.API_URL : 'undefined');
                console.error('- Erro completo:', error);
            }
        }
        
        // ================================================================================
        // CARREGAMENTO DE DADOS
        // ================================================================================
        
        async function carregarVendedores() {
            const select = document.getElementById('filtroVendedor');
            
            // Usar vendedores do config.js
            if (typeof CVC_CONFIG !== 'undefined' && CVC_CONFIG.VENDEDORES) {
                CVC_CONFIG.VENDEDORES.forEach(vendedor => {
                    const option = document.createElement('option');
                    option.value = vendedor;
                    option.textContent = vendedor;
                    select.appendChild(option);
                });
            }
        }
        
        async function carregarEmbarques() {
            try {
                console.log('📊 Carregando embarques da API...');
                
                // Usar JSONP como o modelo antigo que funcionava
                const dados = await fazerRequisicaoJSONP(CVC_CONFIG.API_URL, {
                    action: 'listarEmbarques',
                    t: Date.now()
                });
                
                if (!dados.success) {
                    throw new Error(dados.message || 'Erro desconhecido na API');
                }
                
                dadosEmbarques = dados.data.embarques || [];
                
                console.log(`✅ ${dadosEmbarques.length} embarques carregados da API`);
                
            } catch (error) {
                console.warn('⚠️ API não disponível, usando dados simulados para teste:', error.message);
                
                // Fallback com dados simulados para teste
                dadosEmbarques = gerarDadosSimulados();
                console.log(`🧪 ${dadosEmbarques.length} embarques simulados carregados para teste`);
                
                mostrarAlerta('Sistema em modo de teste - conecte com a planilha para dados reais', 'warning');
            }
            
            // Processar e renderizar dashboards
            processarDashboards();
            
            // Atualizar timestamp
            document.getElementById('ultimaAtualizacao').textContent = 
                new Date().toLocaleString('pt-BR');
        }
        
        // Função para gerar dados simulados para teste
        function gerarDadosSimulados() {
            const vendedores = ['Alessandro', 'Ana Paula', 'Adriana', 'Adrielly', 'Bia'];
            const nomes = ['Maria Silva', 'João Santos', 'Ana Costa', 'Carlos Lima', 'Fernanda Oliveira', 'Pedro Souza', 'Julia Pereira', 'Roberto Alves'];
            const cias = ['GOL', 'LATAM', 'AZUL', 'AVIANCA'];
            const origens = ['São Paulo', 'Rio de Janeiro', 'Brasília', 'Salvador', 'Fortaleza'];
            const destinos = ['Miami', 'Lisboa', 'Paris', 'Buenos Aires', 'Santiago', 'Madrid', 'Roma'];
            
            const dados = [];
            const hoje = new Date();
            
            // Gerar dados para conferências (pendentes)
            for (let i = 0; i < 8; i++) {
                const dataIda = new Date(hoje);
                dataIda.setDate(hoje.getDate() + Math.floor(Math.random() * 20) + 5); // 5-25 dias futuros
                
                const recibo = `CVC${(622000000 + Math.floor(Math.random() * 999999)).toString()}`;
                
                dados.push({
                    id: 1000 + i,
                    numeroInforme: `MIGRADO-036-33282${i}`,
                    vendedor: vendedores[i % vendedores.length],
                    nomeCliente: nomes[i % nomes.length],
                    cpfCliente: `${(100000000 + Math.floor(Math.random() * 899999999)).toString().replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}`,
                    whatsappCliente: `(11) 9${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}-${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}`,
                    dataIda: dataIda.toISOString().split('T')[0],
                    dataVolta: Math.random() > 0.5 ? new Date(dataIda.getTime() + (7 + Math.floor(Math.random() * 14)) * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : null,
                    tipo: Math.random() > 0.3 ? 'Aéreo' : 'A+H',
                    cia: cias[i % cias.length],
                    tipoAereo: Math.random() > 0.3 ? 'RT' : 'OW',
                    conferenciaFeita: false,
                    checkinFeito: false,
                    posVendaFeita: false,
                    observacoes: '',
                    recibo: recibo,
                    locGds: `GDS${Math.random().toString(36).substr(2, 6).toUpperCase()}`,
                    locCia: `${cias[i % cias.length]}${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                    temBagagem: ['Sim', 'Não', 'Não informado'][Math.floor(Math.random() * 3)],
                    temAssento: ['Sim', 'Não', 'Não informado'][Math.floor(Math.random() * 3)],
                    seguro: ['Sim', 'Não', 'Recusado', 'Não informado'][Math.floor(Math.random() * 4)],
                    clienteAle: Math.random() > 0.8 ? 'Sim' : 'Não',
                    reserva: `RES${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
                    origem: origens[Math.floor(Math.random() * origens.length)],
                    destino: destinos[Math.floor(Math.random() * destinos.length)]
                });
            }
            
            // Gerar dados para check-ins (próximos)
            for (let i = 0; i < 5; i++) {
                const dataIda = new Date(hoje);
                dataIda.setDate(hoje.getDate() + Math.floor(Math.random() * 3)); // 0-3 dias
                
                const recibo = `CVC${(622000000 + Math.floor(Math.random() * 999999)).toString()}`;
                
                dados.push({
                    id: 2000 + i,
                    numeroInforme: `CHECKIN-00${i}`,
                    vendedor: vendedores[i % vendedores.length],
                    nomeCliente: nomes[i % nomes.length] + ' (Check-in)',
                    cpfCliente: `${(200000000 + Math.floor(Math.random() * 799999999)).toString().replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}`,
                    whatsappCliente: `(11) 8${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}-${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}`,
                    dataIda: dataIda.toISOString().split('T')[0],
                    dataVolta: Math.random() > 0.4 ? new Date(dataIda.getTime() + (5 + Math.floor(Math.random() * 10)) * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : null,
                    tipo: Math.random() > 0.4 ? 'Aéreo' : 'A+H',
                    cia: cias[i % cias.length],
                    tipoAereo: Math.random() > 0.4 ? 'RT' : 'OW',
                    conferenciaFeita: true, // Já conferido
                    checkinFeito: false, // Pendente
                    posVendaFeita: false,
                    observacoes: '',
                    recibo: recibo,
                    locGds: `LOC${Math.random().toString(36).substr(2, 6).toUpperCase()}`,
                    locCia: `${cias[i % cias.length]}${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                    temBagagem: ['Sim', 'Não'][Math.floor(Math.random() * 2)],
                    temAssento: ['Sim', 'Não'][Math.floor(Math.random() * 2)],
                    seguro: ['Sim', 'Não', 'Recusado'][Math.floor(Math.random() * 3)],
                    clienteAle: Math.random() > 0.7 ? 'Sim' : 'Não',
                    reserva: `CHK${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
                    origem: origens[Math.floor(Math.random() * origens.length)],
                    destino: destinos[Math.floor(Math.random() * destinos.length)]
                });
            }
            
            // Gerar dados para pós-vendas (retornados)
            for (let i = 0; i < 3; i++) {
                const dataIda = new Date(hoje);
                dataIda.setDate(hoje.getDate() - Math.floor(Math.random() * 10) - 5); // 5-15 dias atrás
                
                const dataVolta = new Date(dataIda);
                dataVolta.setDate(dataIda.getDate() + 7 + Math.floor(Math.random() * 7)); // 7-14 dias de viagem
                
                const recibo = `CVC${(622000000 + Math.floor(Math.random() * 999999)).toString()}`;
                
                dados.push({
                    id: 3000 + i,
                    numeroInforme: `POSVENDA-00${i}`,
                    vendedor: vendedores[i % vendedores.length],
                    nomeCliente: nomes[i % nomes.length] + ' (Retornado)',
                    cpfCliente: `${(300000000 + Math.floor(Math.random() * 699999999)).toString().replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}`,
                    whatsappCliente: `(11) 7${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}-${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 9)}`,
                    dataIda: dataIda.toISOString().split('T')[0],
                    dataVolta: dataVolta.toISOString().split('T')[0],
                    tipo: 'A+H',
                    cia: cias[i % cias.length],
                    tipoAereo: 'RT',
                    conferenciaFeita: true,
                    checkinFeito: true,
                    posVendaFeita: false, // Pendente
                    observacoes: '',
                    recibo: recibo,
                    locGds: `PSGDS${Math.random().toString(36).substr(2, 5).toUpperCase()}`,
                    locCia: `${cias[i % cias.length]}${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                    temBagagem: 'Sim',
                    temAssento: 'Sim',
                    seguro: ['Sim', 'Não'][Math.floor(Math.random() * 2)],
                    clienteAle: Math.random() > 0.6 ? 'Sim' : 'Não',
                    reserva: `PSV${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
                    origem: origens[Math.floor(Math.random() * origens.length)],
                    destino: destinos[Math.floor(Math.random() * destinos.length)]
                });
            }
            
            return dados;
        }
        
        // Função JSONP para compatibilidade com Google Apps Script
        function fazerRequisicaoJSONP(url, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Criar função callback global temporária
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    resolve(data);
                };
                
                // Adicionar callback aos parâmetros
                const urlParams = new URLSearchParams();
                Object.keys(params).forEach(key => {
                    urlParams.append(key, params[key]);
                });
                urlParams.append('callback', callbackName);
                
                // Criar script tag
                const script = document.createElement('script');
                script.src = url + '?' + urlParams.toString();
                
                script.onerror = () => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('Falha na requisição JSONP - Verifique se a API está funcionando'));
                };
                
                script.onload = () => {
                    // Script carregou, aguardar callback
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (script.parentNode) {
                                document.body.removeChild(script);
                            }
                            reject(new Error('API não retornou dados válidos'));
                        }
                    }, 10000);
                };
                
                // Timeout geral
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.body.removeChild(script);
                        }
                        reject(new Error('Timeout na requisição JSONP (30s)'));
                    }
                }, 30000);
                
                document.body.appendChild(script);
            });
        }
        
        // ================================================================================
        // PROCESSAMENTO DE DASHBOARDS
        // ================================================================================
        
        function processarDashboards() {
            console.log('⚙️ Processando dashboards...');
            console.log('📊 Total de embarques recebidos:', dadosEmbarques.length);
            
            // Verificar se há dados válidos
            if (!Array.isArray(dadosEmbarques) || dadosEmbarques.length === 0) {
                console.warn('⚠️ Nenhum dado de embarque disponível');
                mostrarEmptyStates();
                return;
            }
            
            // Resetar dados filtrados
            dadosFiltrados = {
                conferencias: [],
                checkins: [],
                posVendas: []
            };
            
            // Processar conferências (agrupadas por informe)
            processarConferencias();
            console.log('✅ Conferências processadas:', dadosFiltrados.conferencias.length);
            
            // Processar check-ins (individuais por voo)
            processarCheckins();
            console.log('✅ Check-ins processados:', dadosFiltrados.checkins.length);
            
            // Processar pós-vendas (agrupadas, ativadas por data)
            processarPosVendas();
            console.log('✅ Pós-vendas processadas:', dadosFiltrados.posVendas.length);
            
            // Renderizar dashboards
            renderizarDashboards();
        }
        
        function mostrarEmptyStates() {
            // Mostrar estados vazios em todos os dashboards
            document.getElementById('conferenciasContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <p>Conectando com a planilha...</p>
                    <small>Verifique sua conexão com a internet</small>
                </div>
            `;
            
            document.getElementById('checkinsContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-plane-departure"></i>
                    <p>Conectando com a planilha...</p>
                    <small>Verifique sua conexão com a internet</small>
                </div>
            `;
            
            document.getElementById('posVendasContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-star"></i>
                    <p>Conectando com a planilha...</p>
                    <small>Verifique sua conexão com a internet</small>
                </div>
            `;
            
            // Zerar contadores
            atualizarContadores();
        }
        
        function processarConferencias() {
            const informes = {};
            
            // Agrupar por número do informe
            dadosEmbarques.forEach(embarque => {
                if (!embarque.numeroInforme || embarque.conferenciaFeita) return;
                
                if (!informes[embarque.numeroInforme]) {
                    informes[embarque.numeroInforme] = {
                        numeroInforme: embarque.numeroInforme,
                        vendedor: embarque.vendedor,
                        clientes: new Set(),
                        datas: [],
                        voos: [],
                        cpfPrincipal: embarque.cpfCliente
                    };
                }
                
                const informe = informes[embarque.numeroInforme];
                informe.clientes.add(embarque.nomeCliente);
                informe.datas.push(new Date(embarque.dataIda));
                informe.voos.push(embarque);
            });
            
            // Converter para array e calcular prioridades
            dadosFiltrados.conferencias = Object.values(informes).map(informe => {
                const primeiraData = new Date(Math.min(...informe.datas));
                const diasParaConferencia = calcularDiasRestantes(primeiraData) - 10;
                
                return {
                    ...informe,
                    clientes: Array.from(informe.clientes),
                    primeiraData: primeiraData,
                    diasParaConferencia: diasParaConferencia,
                    prioridade: calcularPrioridadeConferencia(diasParaConferencia),
                    totalVoos: informe.voos.length
                };
            });
            
            // Ordenar por prioridade
            dadosFiltrados.conferencias.sort((a, b) => {
                const ordemPrioridade = { 'ATRASADO': 0, 'URGENTE': 1, 'PROXIMO': 2, 'NORMAL': 3 };
                return ordemPrioridade[a.prioridade] - ordemPrioridade[b.prioridade];
            });
        }
        
        function processarCheckins() {
            dadosFiltrados.checkins = dadosEmbarques.filter(embarque => {
                if (!embarque.dataIda || embarque.checkinFeito) return false;
                
                const dataVoo = new Date(embarque.dataIda);
                const diasParaVoo = calcularDiasRestantes(dataVoo) - 2;
                
                // Só mostrar se está dentro da janela de check-in (2 dias antes ou menos)
                return diasParaVoo <= 0;
                
            }).map(embarque => {
                const dataVoo = new Date(embarque.dataIda);
                const diasParaCheckin = calcularDiasRestantes(dataVoo) - 2;
                
                return {
                    ...embarque,
                    diasParaCheckin: diasParaCheckin,
                    prioridade: calcularPrioridadeCheckin(diasParaCheckin)
                };
            });
            
            // Ordenar por prioridade
            dadosFiltrados.checkins.sort((a, b) => {
                const ordemPrioridade = { 'ATRASADO': 0, 'URGENTE': 1, 'PROXIMO': 2, 'NORMAL': 3 };
                return ordemPrioridade[a.prioridade] - ordemPrioridade[b.prioridade];
            });
        }
        
        function processarPosVendas() {
            const informes = {};
            
            // Agrupar por número do informe
            dadosEmbarques.forEach(embarque => {
                if (!embarque.numeroInforme || embarque.posVendaFeita) return;
                
                if (!informes[embarque.numeroInforme]) {
                    informes[embarque.numeroInforme] = {
                        numeroInforme: embarque.numeroInforme,
                        vendedor: embarque.vendedor,
                        clientes: new Set(),
                        datasVolta: [],
                        voos: [],
                        cpfPrincipal: embarque.cpfCliente
                    };
                }
                
                const informe = informes[embarque.numeroInforme];
                informe.clientes.add(embarque.nomeCliente);
                
                // Considerar tanto data de volta quanto data de ida (para voos só de ida)
                if (embarque.dataVolta) {
                    informe.datasVolta.push(new Date(embarque.dataVolta));
                } else {
                    informe.datasVolta.push(new Date(embarque.dataIda));
                }
                
                informe.voos.push(embarque);
            });
            
            // Converter para array e filtrar por data
            dadosFiltrados.posVendas = Object.values(informes).filter(informe => {
                const ultimaData = new Date(Math.max(...informe.datasVolta));
                const diasAposRetorno = calcularDiasPassados(ultimaData);
                
                // Ativar pós-venda 1 dia após o retorno
                return diasAposRetorno >= 1;
                
            }).map(informe => {
                const ultimaData = new Date(Math.max(...informe.datasVolta));
                const diasAposRetorno = calcularDiasPassados(ultimaData);
                
                return {
                    ...informe,
                    clientes: Array.from(informe.clientes),
                    ultimaData: ultimaData,
                    diasAposRetorno: diasAposRetorno,
                    prioridade: 'NORMAL', // Pós-venda não tem urgência crítica
                    totalVoos: informe.voos.length
                };
            });
            
            // Ordenar por data (mais antigos primeiro)
            dadosFiltrados.posVendas.sort((a, b) => b.diasAposRetorno - a.diasAposRetorno);
        }
        
        // ================================================================================
        // CÁLCULO DE PRIORIDADES
        // ================================================================================
        
        function calcularPrioridadeConferencia(diasRestantes) {
            if (diasRestantes <= -1) return 'ATRASADO';
            if (diasRestantes <= 0) return 'URGENTE';
            if (diasRestantes <= 3) return 'PROXIMO';
            return 'NORMAL';
        }
        
        function calcularPrioridadeCheckin(diasRestantes) {
            if (diasRestantes <= -1) return 'ATRASADO';
            if (diasRestantes <= 0) return 'URGENTE';
            if (diasRestantes <= 1) return 'PROXIMO';
            return 'NORMAL';
        }
        
        function calcularDiasRestantes(dataFutura) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const dataAlvo = new Date(dataFutura);
            dataAlvo.setHours(0, 0, 0, 0);
            
            const diffTime = dataAlvo.getTime() - hoje.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        function calcularDiasPassados(dataPassada) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const dataAlvo = new Date(dataPassada);
            dataAlvo.setHours(0, 0, 0, 0);
            
            const diffTime = hoje.getTime() - dataAlvo.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // ================================================================================
        // RENDERIZAÇÃO DE DASHBOARDS
        // ================================================================================
        
        function renderizarDashboards() {
            renderizarConferencias();
            renderizarCheckins();
            renderizarPosVendas();
            atualizarContadores();
        }
        
        function renderizarConferencias() {
            const container = document.getElementById('conferenciasContent');
            const conferencias = aplicarFiltrosLista(dadosFiltrados.conferencias);
            
            if (conferencias.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>Nenhuma conferência pendente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = conferencias.map(informe => `
                <div class="embarque-card priority-${informe.prioridade}" 
                     onclick="abrirModalConferencia('${informe.numeroInforme}')">
                    <div class="card-header-custom">
                        <span class="priority-badge ${informe.prioridade}">${informe.prioridade}</span>
                        <span class="days-remaining">${formatarDiasRestantes(informe.diasParaConferencia)}</span>
                    </div>
                    <div class="card-info">
                        <strong>Informe:</strong> ${informe.numeroInforme}
                    </div>
                    <div class="card-info">
                        <strong>Recibos:</strong> ${informe.voos.map(v => v.recibo || 'S/N').filter(r => r !== 'S/N').join(', ') || 'Não informado'}
                    </div>
                    <div class="card-info">
                        <strong>Vendedor:</strong> ${informe.vendedor}
                    </div>
                    <div class="card-info">
                        <strong>Cliente:</strong> ${informe.clientes[0]}
                        ${informe.clientes.length > 1 ? ` (+${informe.clientes.length - 1})` : ''}
                    </div>
                    <div class="card-info">
                        <strong>Primeira viagem:</strong> ${formatarData(informe.primeiraData)}
                    </div>
                    <div class="card-info">
                        <strong>Total de voos:</strong> ${informe.totalVoos}
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-conferencia" onclick="event.stopPropagation(); abrirModalConferencia('${informe.numeroInforme}')">
                            <i class="fas fa-check"></i> Conferir
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderizarCheckins() {
            const container = document.getElementById('checkinsContent');
            const checkins = aplicarFiltrosLista(dadosFiltrados.checkins);
            
            if (checkins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plane-departure"></i>
                        <p>Nenhum check-in pendente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = checkins.map(voo => `
                <div class="embarque-card priority-${voo.prioridade}" 
                     onclick="abrirModalCheckin('${voo.id}')">
                    <div class="card-header-custom">
                        <span class="priority-badge ${voo.prioridade}">${voo.prioridade}</span>
                        <span class="days-remaining">${formatarDiasRestantes(voo.diasParaCheckin)}</span>
                    </div>
                    <div class="card-info">
                        <strong>Recibo:</strong> ${voo.recibo || 'Não informado'}
                    </div>
                    <div class="card-info">
                        <strong>Cliente:</strong> ${voo.nomeCliente}
                    </div>
                    <div class="card-info">
                        <strong>Data do voo:</strong> ${formatarData(voo.dataIda)}
                    </div>
                    <div class="card-info">
                        <strong>Companhia:</strong> ${voo.cia || 'N/A'}
                    </div>
                    <div class="card-info">
                        <strong>Tipo:</strong> ${voo.tipoAereo || voo.tipo}
                    </div>
                    <div class="card-info">
                        <strong>Vendedor:</strong> ${voo.vendedor}
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-checkin" onclick="event.stopPropagation(); abrirModalCheckin('${voo.id}')">
                            <i class="fas fa-plane-departure"></i> Check-in
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderizarPosVendas() {
            const container = document.getElementById('posVendasContent');
            const posVendas = aplicarFiltrosLista(dadosFiltrados.posVendas);
            
            if (posVendas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <p>Nenhuma pós-venda pendente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posVendas.map(informe => `
                <div class="embarque-card priority-${informe.prioridade}" 
                     onclick="abrirModalPosVenda('${informe.numeroInforme}')">
                    <div class="card-header-custom">
                        <span class="priority-badge ${informe.prioridade}">DISPONÍVEL</span>
                        <span class="days-remaining">+${informe.diasAposRetorno} dias</span>
                    </div>
                    <div class="card-info">
                        <strong>Informe:</strong> ${informe.numeroInforme}
                    </div>
                    <div class="card-info">
                        <strong>Recibos:</strong> ${informe.voos.map(v => v.recibo || 'S/N').filter(r => r !== 'S/N').join(', ') || 'Não informado'}
                    </div>
                    <div class="card-info">
                        <strong>Cliente:</strong> ${informe.clientes[0]}
                        ${informe.clientes.length > 1 ? ` (+${informe.clientes.length - 1})` : ''}
                    </div>
                    <div class="card-info">
                        <strong>Retorno:</strong> ${formatarData(informe.ultimaData)}
                    </div>
                    <div class="card-info">
                        <strong>Vendedor:</strong> ${informe.vendedor}
                    </div>
                    <div class="card-info">
                        <strong>Total de voos:</strong> ${informe.totalVoos}
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-pos-venda" onclick="event.stopPropagation(); abrirModalPosVenda('${informe.numeroInforme}')">
                            <i class="fas fa-star"></i> Pós-venda
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ================================================================================
        // FILTROS
        // ================================================================================
        
        function aplicarFiltros() {
            filtrosAtivos.vendedor = document.getElementById('filtroVendedor').value;
            filtrosAtivos.prioridade = document.getElementById('filtroPrioridade').value;
            filtrosAtivos.cliente = document.getElementById('buscaCliente').value.toLowerCase();
            
            renderizarDashboards();
        }
        
        function aplicarFiltrosLista(lista) {
            return lista.filter(item => {
                // Filtro por vendedor
                if (filtrosAtivos.vendedor && item.vendedor !== filtrosAtivos.vendedor) {
                    return false;
                }
                
                // Filtro por prioridade
                if (filtrosAtivos.prioridade && item.prioridade !== filtrosAtivos.prioridade) {
                    return false;
                }
                
                // Filtro por cliente
                if (filtrosAtivos.cliente) {
                    const clientes = Array.isArray(item.clientes) ? item.clientes : [item.nomeCliente];
                    const clienteMatch = clientes.some(cliente => 
                        cliente.toLowerCase().includes(filtrosAtivos.cliente)
                    );
                    
                    const cpfMatch = item.cpfPrincipal && 
                        item.cpfPrincipal.replace(/\D/g, '').includes(filtrosAtivos.cliente.replace(/\D/g, ''));
                    
                    if (!clienteMatch && !cpfMatch) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // ================================================================================
        // MODAIS E AÇÕES
        // ================================================================================
        
        function abrirModalConferencia(numeroInforme) {
            const informe = dadosFiltrados.conferencias.find(i => i.numeroInforme === numeroInforme);
            if (!informe) return;
            
            modalData.conferencia = informe;
            
            document.getElementById('conferencia-info').innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="text-primary mb-0 me-3">
                                <i class="fas fa-clipboard-check"></i> ${informe.numeroInforme}
                            </h5>
                            <span class="priority-badge ${informe.prioridade}">${informe.prioridade}</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Vendedor:</strong> ${informe.vendedor}</p>
                                <p class="mb-2"><strong>Total de voos:</strong> ${informe.totalVoos}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Primeira viagem:</strong> ${formatarData(informe.primeiraData)}</p>
                                <p class="mb-2"><strong>Clientes:</strong> ${informe.clientes.join(', ')}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-info btn-sm mb-2" onclick="buscarOrbiuns('${informe.voos[0]?.whatsappCliente || ''}')">
                            <i class="fas fa-search"></i> Buscar Orbiuns
                        </button>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="text-secondary mb-3">
                    <i class="fas fa-plane"></i> Detalhes dos Voos (${informe.totalVoos} voo${informe.totalVoos > 1 ? 's' : ''})
                </h6>
                
                ${informe.voos.map((voo, index) => `
                    <div class="card mb-4 border-start border-primary border-3">
                        <div class="card-header bg-light">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-0 text-dark">
                                        <i class="fas fa-user"></i> ${voo.nomeCliente}
                                    </h6>
                                    <small class="text-muted">Voo ${index + 1} - ID: ${voo.id}</small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <span class="badge bg-info">${formatarData(voo.dataIda)}</span>
                                    ${voo.cia ? `<span class="badge bg-secondary ms-1">${voo.cia}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Linha 1: Dados pessoais -->
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Nome Completo</strong></label>
                                    <input type="text" class="form-control" 
                                           value="${voo.nomeCliente || ''}" 
                                           data-voo-id="${voo.id}" data-campo="nomeCliente">
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label"><strong>CPF</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               value="${voo.cpfCliente || ''}" 
                                               data-voo-id="${voo.id}" data-campo="cpfCliente"
                                               placeholder="000.000.000-00">
                                        <button class="btn btn-outline-primary" type="button" 
                                                onclick="copiarTexto('${voo.cpfCliente || ''}', 'CPF')" title="Copiar CPF">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label"><strong>WhatsApp</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               value="${voo.whatsappCliente || ''}" 
                                               data-voo-id="${voo.id}" data-campo="whatsappCliente"
                                               placeholder="(11) 99999-9999">
                                        <button class="btn btn-outline-success" type="button" 
                                                onclick="copiarTexto('${voo.whatsappCliente || ''}', 'WhatsApp')" title="Copiar WhatsApp">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Linha 2: Datas e viagem -->
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Data de Ida</strong></label>
                                    <input type="date" class="form-control" 
                                           value="${voo.dataIda || ''}" 
                                           data-voo-id="${voo.id}" data-campo="dataIda">
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Data de Volta</strong></label>
                                    <input type="date" class="form-control" 
                                           value="${voo.dataVolta || ''}" 
                                           data-voo-id="${voo.id}" data-campo="dataVolta">
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Companhia</strong></label>
                                    <input type="text" class="form-control" 
                                           value="${voo.cia || ''}" 
                                           data-voo-id="${voo.id}" data-campo="cia"
                                           placeholder="GOL, LATAM, AZUL...">
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Tipo de Serviço</strong></label>
                                    <select class="form-select" data-voo-id="${voo.id}" data-campo="tipo">
                                        <option value="Aéreo" ${(voo.tipo || 'Aéreo') === 'Aéreo' ? 'selected' : ''}>Aéreo</option>
                                        <option value="A+H" ${voo.tipo === 'A+H' ? 'selected' : ''}>A+H</option>
                                        <option value="Hotel" ${voo.tipo === 'Hotel' ? 'selected' : ''}>Hotel</option>
                                        <option value="Cruzeiro" ${voo.tipo === 'Cruzeiro' ? 'selected' : ''}>Cruzeiro</option>
                                    </select>
                                </div>
                                
                                <!-- Linha 3: Recibo e localizadores -->
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Número do Recibo</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               value="${voo.recibo || ''}" 
                                               data-voo-id="${voo.id}" data-campo="recibo"
                                               placeholder="Número do recibo">
                                        <button class="btn btn-outline-warning" type="button" 
                                                onclick="copiarTexto('${voo.recibo || ''}', 'Recibo')" title="Copiar Recibo">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label"><strong>LOC GDS</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               value="${voo.locGds || ''}" 
                                               data-voo-id="${voo.id}" data-campo="locGds"
                                               placeholder="Localizador GDS">
                                        <button class="btn btn-outline-info" type="button" 
                                                onclick="copiarTexto('${voo.locGds || ''}', 'LOC GDS')" title="Copiar LOC GDS">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label"><strong>LOC CIA</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               value="${voo.locCia || ''}" 
                                               data-voo-id="${voo.id}" data-campo="locCia"
                                               placeholder="Localizador CIA">
                                        <button class="btn btn-outline-info" type="button" 
                                                onclick="copiarTexto('${voo.locCia || ''}', 'LOC CIA')" title="Copiar LOC CIA">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Linha 4: Serviços e opções -->
                                <div class="col-md-2">
                                    <label class="form-label"><strong>Bagagem</strong></label>
                                    <select class="form-select" data-voo-id="${voo.id}" data-campo="temBagagem">
                                        <option value="Não informado" ${(voo.temBagagem || 'Não informado') === 'Não informado' ? 'selected' : ''}>Não informado</option>
                                        <option value="Sim" ${voo.temBagagem === 'Sim' ? 'selected' : ''}>Sim</option>
                                        <option value="Não" ${voo.temBagagem === 'Não' ? 'selected' : ''}>Não</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-2">
                                    <label class="form-label"><strong>Assento</strong></label>
                                    <select class="form-select" data-voo-id="${voo.id}" data-campo="temAssento">
                                        <option value="Não informado" ${(voo.temAssento || 'Não informado') === 'Não informado' ? 'selected' : ''}>Não informado</option>
                                        <option value="Sim" ${voo.temAssento === 'Sim' ? 'selected' : ''}>Sim</option>
                                        <option value="Não" ${voo.temAssento === 'Não' ? 'selected' : ''}>Não</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-2">
                                    <label class="form-label"><strong>Seguro</strong></label>
                                    <select class="form-select" data-voo-id="${voo.id}" data-campo="seguro">
                                        <option value="Não informado" ${(voo.seguro || 'Não informado') === 'Não informado' ? 'selected' : ''}>Não informado</option>
                                        <option value="Sim" ${voo.seguro === 'Sim' ? 'selected' : ''}>Sim</option>
                                        <option value="Não" ${voo.seguro === 'Não' ? 'selected' : ''}>Não</option>
                                        <option value="Recusado" ${voo.seguro === 'Recusado' ? 'selected' : ''}>Recusado</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Reserva</strong></label>
                                    <input type="text" class="form-control" 
                                           value="${voo.reserva || ''}" 
                                           data-voo-id="${voo.id}" data-campo="reserva"
                                           placeholder="Código da reserva">
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Cliente Ale</strong></label>
                                    <select class="form-select" data-voo-id="${voo.id}" data-campo="clienteAle">
                                        <option value="Não" ${(voo.clienteAle || 'Não') === 'Não' ? 'selected' : ''}>Não</option>
                                        <option value="Sim" ${voo.clienteAle === 'Sim' ? 'selected' : ''}>Sim</option>
                                    </select>
                                </div>
                                
                                <!-- Linha 5: Observações -->
                                <div class="col-12">
                                    <label class="form-label"><strong>Observações</strong></label>
                                    <textarea class="form-control" rows="2" 
                                              data-voo-id="${voo.id}" data-campo="observacoes"
                                              placeholder="Observações específicas do voo">${voo.observacoes || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
            
            new bootstrap.Modal(document.getElementById('modalConferencia')).show();
        }
        
        async function confirmarConferencia() {
            try {
                const informe = modalData.conferencia;
                
                const dados = {
                    action: 'marcar_conferencia',
                    cpf: informe.cpfPrincipal,
                    numeroInforme: informe.numeroInforme,
                    desfazer: false
                };
                
                const response = await enviarAcao(dados);
                
                if (response.success) {
                    mostrarAlerta('Conferência marcada com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalConferencia')).hide();
                    await carregarEmbarques();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('❌ Erro ao marcar conferência:', error);
                mostrarAlerta('Erro ao marcar conferência: ' + error.message, 'danger');
            }
        }
        
        function abrirModalCheckin(vooId) {
            const voo = dadosFiltrados.checkins.find(v => v.id == vooId);
            if (!voo) return;
            
            modalData.checkin = voo;
            
            document.getElementById('checkin-info').innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="text-warning mb-0 me-3">
                                <i class="fas fa-plane-departure"></i> ${voo.nomeCliente}
                            </h5>
                            <span class="priority-badge ${voo.prioridade}">${voo.prioridade}</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Data do voo:</strong> ${formatarData(voo.dataIda)}</p>
                                <p class="mb-2"><strong>Vendedor:</strong> ${voo.vendedor}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Companhia:</strong> ${voo.cia || 'N/A'}</p>
                                <p class="mb-2"><strong>Tipo:</strong> ${voo.tipoAereo || voo.tipo}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-info btn-sm mb-2" onclick="buscarOrbiuns('${voo.whatsappCliente || ''}')">
                            <i class="fas fa-search"></i> Buscar Orbiuns
                        </button>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="text-secondary mb-3">
                    <i class="fas fa-edit"></i> Dados do Check-in (Todos Editáveis)
                </h6>
                
                <div class="card border-start border-warning border-3">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-0 text-dark">
                                    <i class="fas fa-plane-departure"></i> Check-in - ID: ${voo.id}
                                </h6>
                                <small class="text-muted">Todos os campos podem ser editados</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <span class="badge bg-warning text-dark">${formatarData(voo.dataIda)}</span>
                                ${voo.cia ? `<span class="badge bg-secondary ms-1">${voo.cia}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Linha 1: Dados pessoais -->
                            <div class="col-md-4">
                                <label class="form-label"><strong>Nome Completo</strong></label>
                                <input type="text" class="form-control" 
                                       value="${voo.nomeCliente || ''}" 
                                       id="editNomeCliente">
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label"><strong>CPF</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="${voo.cpfCliente || ''}" 
                                           id="editCpfCliente"
                                           placeholder="000.000.000-00">
                                    <button class="btn btn-outline-primary" type="button" 
                                            onclick="copiarTexto('${voo.cpfCliente || ''}', 'CPF')" title="Copiar CPF">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label"><strong>WhatsApp</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="${voo.whatsappCliente || ''}" 
                                           id="editWhatsappCliente"
                                           placeholder="(11) 99999-9999">
                                    <button class="btn btn-outline-success" type="button" 
                                            onclick="copiarTexto('${voo.whatsappCliente || ''}', 'WhatsApp')" title="Copiar WhatsApp">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Linha 2: Datas e viagem -->
                            <div class="col-md-3">
                                <label class="form-label"><strong>Data de Ida</strong></label>
                                <input type="date" class="form-control" 
                                       value="${voo.dataIda || ''}" 
                                       id="editDataIda">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label"><strong>Data de Volta</strong></label>
                                <input type="date" class="form-control" 
                                       value="${voo.dataVolta || ''}" 
                                       id="editDataVolta">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label"><strong>Companhia</strong></label>
                                <input type="text" class="form-control" 
                                       value="${voo.cia || ''}" 
                                       id="editCia"
                                       placeholder="GOL, LATAM, AZUL...">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label"><strong>Tipo de Serviço</strong></label>
                                <select class="form-select" id="editTipo">
                                    <option value="Aéreo" ${(voo.tipo || 'Aéreo') === 'Aéreo' ? 'selected' : ''}>Aéreo</option>
                                    <option value="A+H" ${voo.tipo === 'A+H' ? 'selected' : ''}>A+H</option>
                                    <option value="Hotel" ${voo.tipo === 'Hotel' ? 'selected' : ''}>Hotel</option>
                                    <option value="Cruzeiro" ${voo.tipo === 'Cruzeiro' ? 'selected' : ''}>Cruzeiro</option>
                                </select>
                            </div>
                            
                            <!-- Linha 3: Recibo e localizadores -->
                            <div class="col-md-4">
                                <label class="form-label"><strong>Número do Recibo</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="${voo.recibo || ''}" 
                                           id="editRecibo"
                                           placeholder="Número do recibo">
                                    <button class="btn btn-outline-warning" type="button" 
                                            onclick="copiarTexto(document.getElementById('editRecibo').value, 'Recibo')" title="Copiar Recibo">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label"><strong>LOC GDS</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="${voo.locGds || ''}" 
                                           id="editLocGds"
                                           placeholder="Localizador GDS">
                                    <button class="btn btn-outline-info" type="button" 
                                            onclick="copiarTexto(document.getElementById('editLocGds').value, 'LOC GDS')" title="Copiar LOC GDS">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label"><strong>LOC CIA</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="${voo.locCia || ''}" 
                                           id="editLocCia"
                                           placeholder="Localizador CIA">
                                    <button class="btn btn-outline-info" type="button" 
                                            onclick="copiarTexto(document.getElementById('editLocCia').value, 'LOC CIA')" title="Copiar LOC CIA">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Linha 4: Serviços e opções -->
                            <div class="col-md-2">
                                <label class="form-label"><strong>Bagagem</strong></label>
                                <select class="form-select" id="editTemBagagem">
                                    <option value="Não informado" ${(voo.temBagagem || 'Não informado') === 'Não informado' ? 'selected' : ''}>Não informado</option>
                                    <option value="Sim" ${voo.temBagagem === 'Sim' ? 'selected' : ''}>Sim</option>
                                    <option value="Não" ${voo.temBagagem === 'Não' ? 'selected' : ''}>Não</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label"><strong>Assento</strong></label>
                                <select class="form-select" id="editTemAssento">
                                    <option value="Não informado" ${(voo.temAssento || 'Não informado') === 'Não informado' ? 'selected' : ''}>Não informado</option>
                                    <option value="Sim" ${voo.temAssento === 'Sim' ? 'selected' : ''}>Sim</option>
                                    <option value="Não" ${voo.temAssento === 'Não' ? 'selected' : ''}>Não</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label"><strong>Seguro</strong></label>
                                <select class="form-select" id="editSeguro">
                                    <option value="Não informado" ${(voo.seguro || 'Não informado') === 'Não informado' ? 'selected' : ''}>Não informado</option>
                                    <option value="Sim" ${voo.seguro === 'Sim' ? 'selected' : ''}>Sim</option>
                                    <option value="Não" ${voo.seguro === 'Não' ? 'selected' : ''}>Não</option>
                                    <option value="Recusado" ${voo.seguro === 'Recusado' ? 'selected' : ''}>Recusado</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label"><strong>Reserva</strong></label>
                                <input type="text" class="form-control" 
                                       value="${voo.reserva || ''}" 
                                       id="editReserva"
                                       placeholder="Código da reserva">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label"><strong>Cliente Ale</strong></label>
                                <select class="form-select" id="editClienteAle">
                                    <option value="Não" ${(voo.clienteAle || 'Não') === 'Não' ? 'selected' : ''}>Não</option>
                                    <option value="Sim" ${voo.clienteAle === 'Sim' ? 'selected' : ''}>Sim</option>
                                </select>
                            </div>
                            
                            <!-- Linha 5: Observações -->
                            <div class="col-12">
                                <label class="form-label"><strong>Observações do Check-in</strong></label>
                                <textarea class="form-control" rows="3" 
                                          id="editObservacoesCheckin"
                                          placeholder="Observações específicas do check-in">${voo.observacoes || ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('modalCheckin')).show();
        }
        
        async function confirmarCheckin() {
            try {
                const voo = modalData.checkin;
                
                const dados = {
                    action: 'marcar_checkin',
                    cpf: voo.cpfCliente,
                    recibo: voo.recibo,
                    dataVoo: formatarDataAPI(voo.dataIda),
                    desfazer: false
                };
                
                const response = await enviarAcao(dados);
                
                if (response.success) {
                    mostrarAlerta('Check-in marcado com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalCheckin')).hide();
                    await carregarEmbarques();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('❌ Erro ao marcar check-in:', error);
                mostrarAlerta('Erro ao marcar check-in: ' + error.message, 'danger');
            }
        }
        
        function abrirModalPosVenda(numeroInforme) {
            const informe = dadosFiltrados.posVendas.find(i => i.numeroInforme === numeroInforme);
            if (!informe) return;
            
            modalData.posVenda = informe;
            
            document.getElementById('pos-venda-info').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Número do Informe:</strong> ${informe.numeroInforme}</p>
                        <p><strong>Vendedor:</strong> ${informe.vendedor}</p>
                        <p><strong>Data de Retorno:</strong> ${formatarData(informe.ultimaData)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total de Voos:</strong> ${informe.totalVoos}</p>
                        <p><strong>Clientes:</strong> ${informe.clientes.join(', ')}</p>
                        <p><strong>Dias após retorno:</strong> ${informe.diasAposRetorno}</p>
                    </div>
                </div>
            `;
            
            // Limpar formulário
            document.getElementById('formPosVenda').reset();
            
            new bootstrap.Modal(document.getElementById('modalPosVenda')).show();
        }
        
        async function confirmarPosVenda() {
            try {
                const informe = modalData.posVenda;
                
                const dadosEditaveis = {
                    observacoes: document.getElementById('observacoes').value,
                    grupoOfertas: document.getElementById('grupoOfertas').value,
                    postouInsta: document.getElementById('postouInsta').value,
                    avaliacaoGoogle: document.getElementById('avaliacaoGoogle').value,
                    sac: document.getElementById('sac').value,
                    numeroSAC: document.getElementById('numeroSAC').value
                };
                
                const dados = {
                    action: 'marcar_pos_venda',
                    cpf: informe.cpfPrincipal,
                    numeroInforme: informe.numeroInforme,
                    dadosEditaveis: JSON.stringify(dadosEditaveis),
                    desfazer: false
                };
                
                const response = await enviarAcao(dados);
                
                if (response.success) {
                    mostrarAlerta('Pós-venda marcada com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalPosVenda')).hide();
                    await carregarEmbarques();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('❌ Erro ao marcar pós-venda:', error);
                mostrarAlerta('Erro ao marcar pós-venda: ' + error.message, 'danger');
            }
        }
        
        // ================================================================================
        // UTILITÁRIOS E API
        // ================================================================================
        
        async function enviarAcao(dados) {
            try {
                // Para ações POST, usar formulário oculto como o modelo antigo
                return await fazerRequisicaoPOST(CVC_CONFIG.API_URL, dados);
            } catch (error) {
                console.error('❌ Erro na ação:', error);
                throw error;
            }
        }
        
        // Função para enviar POST via formulário (compatível com Google Apps Script)
        function fazerRequisicaoPOST(url, dados) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_post_' + Math.round(100000 * Math.random());
                
                // Criar função callback global temporária
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    resolve(data);
                };
                
                // Adicionar callback aos dados
                dados.callback = callbackName;
                
                // Criar formulário oculto
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = url;
                form.target = callbackName + '_iframe';
                form.style.display = 'none';
                
                // Adicionar campos do formulário
                Object.keys(dados).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = typeof dados[key] === 'object' ? JSON.stringify(dados[key]) : dados[key];
                    form.appendChild(input);
                });
                
                // Criar iframe oculto para receber resposta
                const iframe = document.createElement('iframe');
                iframe.name = callbackName + '_iframe';
                iframe.style.display = 'none';
                
                // Usar JSONP para POST
                const script = document.createElement('script');
                const urlParams = new URLSearchParams();
                Object.keys(dados).forEach(key => {
                    urlParams.append(key, typeof dados[key] === 'object' ? JSON.stringify(dados[key]) : dados[key]);
                });
                script.src = url + '?' + urlParams.toString();
                
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Falha na requisição POST'));
                };
                
                // Timeout
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) document.body.removeChild(script);
                        reject(new Error('Timeout na requisição POST'));
                    }
                }, 30000);
                
                document.body.appendChild(script);
            });
        }
        
        function atualizarContadores() {
            document.getElementById('contadorConferencias').textContent = 
                aplicarFiltrosLista(dadosFiltrados.conferencias).length;
            
            document.getElementById('contadorCheckins').textContent = 
                aplicarFiltrosLista(dadosFiltrados.checkins).length;
            
            document.getElementById('contadorPosVendas').textContent = 
                aplicarFiltrosLista(dadosFiltrados.posVendas).length;
        }
        
        function configurarAutoRefresh() {
            setInterval(async () => {
                try {
                    await carregarEmbarques();
                    console.log('🔄 Auto-refresh executado');
                } catch (error) {
                    console.error('❌ Erro no auto-refresh:', error);
                }
            }, 5 * 60 * 1000); // 5 minutos
        }
        
        // Funções de formatação
        function formatarData(data) {
            if (!data) return 'N/A';
            return new Date(data).toLocaleDateString('pt-BR');
        }
        
        function formatarDataAPI(data) {
            if (!data) return '';
            return new Date(data).toISOString().split('T')[0];
        }
        
        function formatarDiasRestantes(dias) {
            if (dias < 0) {
                return `${Math.abs(dias)} dia(s) atrás`;
            } else if (dias === 0) {
                return 'Hoje';
            } else {
                return `${dias} dia(s)`;
            }
        }
        
        // Funções de interface
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarAlerta(mensagem, tipo) {
            const container = document.getElementById('alertContainer');
            const alertClass = tipo === 'success' ? 'alert-success-custom' : 'alert-danger-custom';
            
            container.innerHTML = `
                <div class="alert alert-custom ${alertClass} alert-dismissible fade show" role="alert">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    new bootstrap.Alert(alert).close();
                }
            }, 5000);
        }
        
        // Funções de navegação
        function voltarDashboard() {
            window.location.href = 'index.html';
        }
        
        async function recarregarEmbarques() {
            try {
                mostrarLoading(true);
                await carregarEmbarques();
                mostrarAlerta('Embarques atualizados com sucesso!', 'success');
            } catch (error) {
                mostrarAlerta('Erro ao atualizar embarques: ' + error.message, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }
        
        function exportarRelatorio() {
            // TODO: Implementar exportação para Excel/PDF
            mostrarAlerta('Funcionalidade de exportação em desenvolvimento', 'warning');
        }
        
        // Função de teste de conectividade
        async function testarConectividade() {
            try {
                mostrarLoading(true);
                console.log('🧪 Testando conectividade com a API...');
                
                const dados = await fazerRequisicaoJSONP(CVC_CONFIG.API_URL, {
                    action: 'ping',
                    teste: 'conectividade'
                });
                
                console.log('📡 Resposta do teste:', dados);
                
                if (dados.success) {
                    mostrarAlerta(`✅ API funcionando! Versão: ${dados.versao || 'N/A'}`, 'success');
                } else {
                    mostrarAlerta(`⚠️ API respondeu mas com erro: ${dados.message}`, 'warning');
                }
                
            } catch (error) {
                console.error('❌ Erro no teste de conectividade:', error);
                mostrarAlerta(`❌ Falha na conectividade: ${error.message}`, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }
        
        // Função para salvar edições dos modais
        async function salvarEdicoes(tipo) {
            try {
                if (tipo === 'conferencia') {
                    const informe = modalData.conferencia;
                    const edicoes = [];
                    
                    // Capturar edições de todos os voos do informe
                    informe.voos.forEach(voo => {
                        const cpfInput = document.querySelector(`[data-voo-id="${voo.id}"][data-campo="cpfCliente"]`);
                        const whatsappInput = document.querySelector(`[data-voo-id="${voo.id}"][data-campo="whatsappCliente"]`);
                        const obsInput = document.querySelector(`[data-voo-id="${voo.id}"][data-campo="observacoes"]`);
                        
                        if (cpfInput || whatsappInput || obsInput) {
                            edicoes.push({
                                id: voo.id,
                                cpfCliente: cpfInput ? cpfInput.value : voo.cpfCliente,
                                whatsappCliente: whatsappInput ? whatsappInput.value : voo.whatsappCliente,
                                observacoes: obsInput ? obsInput.value : voo.observacoes
                            });
                        }
                    });
                    
                    if (edicoes.length > 0) {
                        console.log('💾 Salvando edições da conferência:', edicoes);
                        // TODO: Implementar salvamento via API
                        mostrarAlerta('Edições salvas com sucesso! (Implementação pendente)', 'success');
                    }
                    
                } else if (tipo === 'checkin') {
                    const voo = modalData.checkin;
                    
                    const edicoes = {
                        id: voo.id,
                        locGds: document.getElementById('editLocGds').value,
                        locCia: document.getElementById('editLocCia').value,
                        temBagagem: document.getElementById('editTemBagagem').value,
                        temAssento: document.getElementById('editTemAssento').value,
                        observacoes: document.getElementById('editObservacoesCheckin').value
                    };
                    
                    console.log('💾 Salvando edições do check-in:', edicoes);
                    // TODO: Implementar salvamento via API
                    mostrarAlerta('Edições salvas com sucesso! (Implementação pendente)', 'success');
                }
                
            } catch (error) {
                console.error('❌ Erro ao salvar edições:', error);
                mostrarAlerta('Erro ao salvar edições: ' + error.message, 'danger');
            }
        }
        
        // Função para copiar texto para área de transferência
        async function copiarTexto(texto, tipo) {
            try {
                if (!texto || texto.trim() === '') {
                    mostrarAlerta(`Nenhum ${tipo} para copiar`, 'warning');
                    return;
                }
                
                await navigator.clipboard.writeText(texto);
                mostrarAlerta(`${tipo} copiado: ${texto}`, 'success');
                
            } catch (error) {
                console.error('❌ Erro ao copiar:', error);
                
                // Fallback para navegadores mais antigos
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    mostrarAlerta(`${tipo} copiado: ${texto}`, 'success');
                } catch (fallbackError) {
                    mostrarAlerta('Erro ao copiar texto', 'danger');
                }
            }
        }
        
        // Função para buscar orbiuns
        async function buscarOrbiuns(whatsapp) {
            try {
                if (!whatsapp || whatsapp.trim() === '') {
                    mostrarAlerta('WhatsApp não informado para buscar orbiuns', 'warning');
                    return;
                }
                
                console.log('🔍 Buscando orbiuns para WhatsApp:', whatsapp);
                
                // Chamar API para buscar orbiuns
                const dados = await fazerRequisicaoJSONP(CVC_CONFIG.API_URL, {
                    action: 'buscarOrbiuns',
                    whatsapp: whatsapp,
                    t: Date.now()
                });
                
                if (dados.success && dados.data && dados.data.orbiuns) {
                    const orbiuns = dados.data.orbiuns;
                    
                    if (orbiuns.length > 0) {
                        mostrarModalOrbiuns(orbiuns, whatsapp);
                    } else {
                        mostrarAlerta(`Nenhum orbiun encontrado para ${whatsapp}`, 'info');
                    }
                } else {
                    mostrarAlerta('Erro ao buscar orbiuns: ' + (dados.message || 'Resposta inválida'), 'danger');
                }
                
            } catch (error) {
                console.error('❌ Erro ao buscar orbiuns:', error);
                
                // Fallback: mostrar dados simulados
                const orbiunsSimulados = [
                    {
                        id: 1,
                        titulo: 'Cotação - Pacote Nordeste',
                        departamento: 'Vendas',
                        responsavel: 'Alessandro',
                        status: 'Em Andamento',
                        dataAbertura: '2024-12-01',
                        prioridade: 'Normal',
                        observacoes: 'Cliente interessado em pacote para Natal/RN'
                    },
                    {
                        id: 2,
                        titulo: 'Dúvida sobre Documentação',
                        departamento: 'Atendimento',
                        responsavel: 'Ana Paula',
                        status: 'Pendente',
                        dataAbertura: '2024-12-03',
                        prioridade: 'Baixa',
                        observacoes: 'Esclarecimentos sobre passaporte'
                    }
                ];
                
                mostrarModalOrbiuns(orbiunsSimulados, whatsapp, true);
            }
        }
        
        // Função para mostrar modal com orbiuns encontrados
        function mostrarModalOrbiuns(orbiuns, whatsapp, simulado = false) {
            const modalHtml = `
                <div class="modal fade" id="modalOrbiuns" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-search"></i> Orbiuns Encontrados
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <strong>WhatsApp pesquisado:</strong> ${whatsapp}
                                    ${simulado ? '<br><small class="text-muted">Dados simulados - conecte com a API real</small>' : ''}
                                </div>
                                
                                <div class="row">
                                    ${orbiuns.map(orbiun => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0">${orbiun.titulo}</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="mb-1"><strong>Departamento:</strong> ${orbiun.departamento}</p>
                                                    <p class="mb-1"><strong>Responsável:</strong> ${orbiun.responsavel}</p>
                                                    <p class="mb-1"><strong>Status:</strong> 
                                                        <span class="badge ${orbiun.status === 'Em Andamento' ? 'bg-warning' : 'bg-secondary'}">${orbiun.status}</span>
                                                    </p>
                                                    <p class="mb-1"><strong>Data:</strong> ${formatarData(orbiun.dataAbertura)}</p>
                                                    <p class="mb-1"><strong>Prioridade:</strong> ${orbiun.prioridade}</p>
                                                    ${orbiun.observacoes ? `<p class="mb-0"><small class="text-muted">${orbiun.observacoes}</small></p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                ${orbiuns.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Nenhum orbiun encontrado para este WhatsApp</p>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="button" class="btn btn-primary" onclick="abrirOrbiuns()">
                                    <i class="fas fa-external-link-alt"></i> Abrir Orbiuns
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalExistente = document.getElementById('modalOrbiuns');
            if (modalExistente) {
                modalExistente.remove();
            }
            
            // Adicionar novo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalOrbiuns')).show();
        }
        
        // Função para abrir página de orbiuns
        function abrirOrbiuns() {
            window.open('orbiuns.html', '_blank');
        }
    </script>
</body>
</html>
