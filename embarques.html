<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVC Portal Itaqu√° - Controle de Embarques</title>
    
    <!-- Meta Tags Conforme Manual CVC -->
    <meta name="description" content="CVC Portal Itaqu√° - Sistema Integrado de Gest√£o para a filial de Itaquaquecetuba">
    <meta name="keywords" content="CVC, Itaquaquecetuba, gest√£o, viagens, turismo, sistema, embarques">
    <meta name="author" content="CVC Itaquaquecetuba">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="CVC Portal Itaqu√° - Controle de Embarques">
    <meta property="og:description" content="Sistema de controle de embarques da CVC Itaquaquecetuba">
    <meta property="og:image" content="assets/images/cvc-logo.png">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="assets/images/cvc-favicon.ico">
    <link rel="apple-touch-icon" href="assets/images/cvc-apple-icon.png">
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/cvc-styles.css" rel="stylesheet">
    
    <!-- Configura√ß√£o -->
    <script src="config.js"></script>
    
    <style>
        /* ================================================================================
         * ESTILOS ESPEC√çFICOS PARA EMBARQUES v12.0 - DASHBOARDS TEMPORAIS
         * ================================================================================ */
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--cvc-sombra-forte);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1400px;
            overflow: hidden;
        }
        
        .content-section {
            padding: 30px;
        }
        
        /* DASHBOARDS */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .dashboard-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 600px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--cvc-azul-principal);
        }
        
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--cvc-azul-principal);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dashboard-counter {
            background: var(--cvc-azul-principal);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* CARDS DE EMBARQUES */
        .embarque-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .embarque-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        /* PRIORIDADES */
        .priority-ATRASADO {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff, #ffebee);
        }
        
        .priority-URGENTE {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff, #fff8e7);
        }
        
        .priority-PROXIMO {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff, #fffbf0);
        }
        
        .priority-NORMAL {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #fff, #f0fff4);
        }
        
        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .priority-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-badge.ATRASADO {
            background: #dc3545;
            color: white;
        }
        
        .priority-badge.URGENTE {
            background: #fd7e14;
            color: white;
        }
        
        .priority-badge.PROXIMO {
            background: #ffc107;
            color: #000;
        }
        
        .priority-badge.NORMAL {
            background: #28a745;
            color: white;
        }
        
        .days-remaining {
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
        }
        
        .card-info {
            margin: 8px 0;
        }
        
        .card-info strong {
            color: var(--cvc-azul-principal);
        }
        
        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }
        
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-conferencia {
            background: var(--cvc-azul-principal);
            color: white;
        }
        
        .btn-checkin {
            background: var(--cvc-laranja);
            color: white;
        }
        
        .btn-pos-venda {
            background: var(--cvc-verde);
            color: white;
        }
        
        .btn-action:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        
        /* CONTROLES SUPERIORES */
        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: bold;
            color: var(--cvc-azul-principal);
            font-size: 0.9rem;
        }
        
        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* STATUS E M√âTRICAS */
        .status-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        .status-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: space-between;
            }
            
            .status-section {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* MODAL ESTILOS */
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: var(--cvc-azul-principal);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .form-floating label {
            color: #666;
        }
        
        /* SUCCESS/ERROR ALERTS */
        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 12px 20px;
            margin-bottom: 15px;
        }
        
        .alert-success-custom {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }
        
        .alert-danger-custom {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }
    </style>
</head>
<body class="cvc-background">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="loading-spinner"></div>
            <div class="mt-3">Carregando embarques v12.0...</div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="main-container">
            <!-- Header CVC -->
            <header class="cvc-header">
                <div class="container-fluid">
                    <div class="row align-items-center py-3">
                        <div class="col-md-4">
                            <div class="cvc-logo">
                                <div class="cvc-logo-symbol">CVC</div>
                                <div>
                                    <div class="cvc-logo-text">CVC Portal Itaqu√°</div>
                                    <p class="cvc-subtitle">Controle de Embarques v12.0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-center">
                            <h1 class="cvc-page-title">Controle de Embarques</h1>
                            <p class="cvc-subtitle-page">Confer√™ncias ‚Ä¢ Check-ins ‚Ä¢ P√≥s-vendas</p>
                        </div>
                        
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-light btn-sm me-2" onclick="voltarDashboard()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-light btn-sm me-2" onclick="recarregarEmbarques()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="testarConectividade()">
                                <i class="fas fa-wifi"></i> Testar API
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Conte√∫do Principal -->
            <main class="content-section">
                <!-- Status e M√©tricas -->
                <div class="status-section">
                    <div class="status-info">
                        <div class="status-light"></div>
                        <span><strong>Sistema Online</strong> | √öltima atualiza√ß√£o: <span id="ultimaAtualizacao">Carregando...</span></span>
                    </div>
                    <div class="auto-refresh">
                        <i class="fas fa-clock"></i>
                        <span>Auto-refresh: 5min</span>
                    </div>
                </div>

                <!-- Controles e Filtros -->
                <div class="controls-section">
                    <div class="filter-group">
                        <label for="filtroVendedor">Vendedor:</label>
                        <select class="form-select" id="filtroVendedor" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filtroPrioridade">Prioridade:</label>
                        <select class="form-select" id="filtroPrioridade" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="ATRASADO">Atrasados</option>
                            <option value="URGENTE">Urgentes</option>
                            <option value="PROXIMO">Pr√≥ximos</option>
                            <option value="NORMAL">Normais</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="buscaCliente">Cliente:</label>
                        <input type="text" class="form-control" id="buscaCliente" placeholder="Nome ou CPF" 
                               onkeyup="aplicarFiltros()" style="width: 200px;">
                    </div>
                    
                    <div class="filter-group ms-auto">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportarRelatorio()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Alert para mensagens -->
                <div id="alertContainer"></div>

                <!-- Dashboards dos Embarques -->
                <div class="dashboard-container" id="dashboardContainer">
                    <!-- Dashboard de Confer√™ncias -->
                    <div class="dashboard-section" id="conferenciasSection">
                        <div class="dashboard-header">
                            <div class="dashboard-title">
                                <i class="fas fa-clipboard-check"></i>
                                <span>Confer√™ncias</span>
                            </div>
                            <div class="dashboard-counter" id="contadorConferencias">0</div>
                        </div>
                        <div class="dashboard-content" id="conferenciasContent">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-check"></i>
                                <p>Carregando confer√™ncias...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard de Check-ins -->
                    <div class="dashboard-section" id="checkinsSection">
                        <div class="dashboard-header">
                            <div class="dashboard-title">
                                <i class="fas fa-plane-departure"></i>
                                <span>Check-ins</span>
                            </div>
                            <div class="dashboard-counter" id="contadorCheckins">0</div>
                        </div>
                        <div class="dashboard-content" id="checkinsContent">
                            <div class="empty-state">
                                <i class="fas fa-plane-departure"></i>
                                <p>Carregando check-ins...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard de P√≥s-vendas -->
                    <div class="dashboard-section" id="posVendasSection">
                        <div class="dashboard-header">
                            <div class="dashboard-title">
                                <i class="fas fa-star"></i>
                                <span>P√≥s-vendas</span>
                            </div>
                            <div class="dashboard-counter" id="contadorPosVendas">0</div>
                        </div>
                        <div class="dashboard-content" id="posVendasContent">
                            <div class="empty-state">
                                <i class="fas fa-star"></i>
                                <p>Carregando p√≥s-vendas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Confer√™ncia -->
    <div class="modal fade" id="modalConferencia" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Confirmar Confer√™ncia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="conferencia-info"></div>
                    <p class="text-muted mt-3">Esta a√ß√£o ir√° marcar todos os voos deste informe como conferidos.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarConferencia()">
                        <i class="fas fa-check"></i> Confirmar Confer√™ncia
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Check-in -->
    <div class="modal fade" id="modalCheckin" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plane-departure me-2"></i>
                        Confirmar Check-in
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="checkin-info"></div>
                    <p class="text-muted mt-3">Esta a√ß√£o ir√° marcar este voo espec√≠fico como check-in realizado.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="confirmarCheckin()">
                        <i class="fas fa-check"></i> Confirmar Check-in
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de P√≥s-venda -->
    <div class="modal fade" id="modalPosVenda" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-star me-2"></i>
                        P√≥s-venda
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pos-venda-info" class="mb-3"></div>
                    
                    <form id="formPosVenda">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <textarea class="form-control" id="observacoes" style="height: 100px"></textarea>
                                    <label for="observacoes">Observa√ß√µes da Viagem</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="grupoOfertas">
                                        <option value="">Selecione...</option>
                                        <option value="Sim">Sim</option>
                                        <option value="N√£o">N√£o</option>
                                    </select>
                                    <label for="grupoOfertas">Grupo Ofertas WhatsApp</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="postouInsta">
                                        <option value="">Selecione...</option>
                                        <option value="Sim">Sim</option>
                                        <option value="N√£o">N√£o</option>
                                    </select>
                                    <label for="postouInsta">Postou no Instagram</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="avaliacaoGoogle">
                                        <option value="">Selecione...</option>
                                        <option value="Solicitado">Solicitado</option>
                                        <option value="Recusou">Recusou</option>
                                        <option value="J√° tinha">J√° tinha</option>
                                    </select>
                                    <label for="avaliacaoGoogle">Avalia√ß√£o Google</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="sac">
                                        <option value="">Selecione...</option>
                                        <option value="Sim">Sim</option>
                                        <option value="N√£o">N√£o</option>
                                    </select>
                                    <label for="sac">Teve algum problema (SAC)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="numeroSAC">
                                    <label for="numeroSAC">N√∫mero do SAC (se aplic√°vel)</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="confirmarPosVenda()">
                        <i class="fas fa-check"></i> Confirmar P√≥s-venda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ================================================================================
        // CVC PORTAL ITAQU√Å - EMBARQUES v12.0 - SISTEMA DE DASHBOARDS TEMPORAIS
        // ================================================================================
        
        // Vari√°veis globais
        let dadosEmbarques = [];
        let dadosFiltrados = {
            conferencias: [],
            checkins: [],
            posVendas: []
        };
        let filtrosAtivos = {
            vendedor: '',
            prioridade: '',
            cliente: ''
        };
        
        // Dados tempor√°rios para modais
        let modalData = {};
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ CVC Portal Itaqu√° - Embarques v12.0 iniciando...');
            inicializarSistema();
        });
        
        async function inicializarSistema() {
            try {
                console.log('üöÄ CVC Portal Itaqu√° - Embarques v12.0 iniciando...');
                console.log('üîß API URL:', CVC_CONFIG.API_URL);
                console.log('üè™ Filial:', CVC_CONFIG.FILIAL_PADRAO);
                
                mostrarLoading(true);
                
                // Verificar se config est√° carregado
                if (typeof CVC_CONFIG === 'undefined' || !CVC_CONFIG.API_URL) {
                    throw new Error('Configura√ß√£o CVC_CONFIG n√£o encontrada. Verifique se config.js est√° carregado.');
                }
                
                // Carregar vendedores no filtro
                await carregarVendedores();
                console.log('‚úÖ Vendedores carregados');
                
                // Carregar dados dos embarques
                await carregarEmbarques();
                console.log('‚úÖ Embarques carregados');
                
                // Configurar auto-refresh
                configurarAutoRefresh();
                console.log('‚úÖ Auto-refresh configurado');
                
                mostrarLoading(false);
                console.log('‚úÖ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                mostrarAlerta('Erro ao carregar o sistema: ' + error.message, 'danger');
                mostrarLoading(false);
                
                // Mostrar informa√ß√µes de debug
                console.error('üîç Debug Info:');
                console.error('- CVC_CONFIG existe:', typeof CVC_CONFIG !== 'undefined');
                console.error('- API_URL:', typeof CVC_CONFIG !== 'undefined' ? CVC_CONFIG.API_URL : 'undefined');
                console.error('- Erro completo:', error);
            }
        }
        
        // ================================================================================
        // CARREGAMENTO DE DADOS
        // ================================================================================
        
        async function carregarVendedores() {
            const select = document.getElementById('filtroVendedor');
            
            // Usar vendedores do config.js
            if (typeof CVC_CONFIG !== 'undefined' && CVC_CONFIG.VENDEDORES) {
                CVC_CONFIG.VENDEDORES.forEach(vendedor => {
                    const option = document.createElement('option');
                    option.value = vendedor;
                    option.textContent = vendedor;
                    select.appendChild(option);
                });
            }
        }
        
        async function carregarEmbarques() {
            try {
                console.log('üìä Carregando embarques da API...');
                
                // Usar JSONP como o modelo antigo que funcionava
                const dados = await fazerRequisicaoJSONP(CVC_CONFIG.API_URL, {
                    action: 'listarEmbarques',
                    t: Date.now()
                });
                
                if (!dados.success) {
                    throw new Error(dados.message || 'Erro desconhecido na API');
                }
                
                dadosEmbarques = dados.data.embarques || [];
                
                console.log(`‚úÖ ${dadosEmbarques.length} embarques carregados`);
                
                // Processar e renderizar dashboards
                processarDashboards();
                
                // Atualizar timestamp
                document.getElementById('ultimaAtualizacao').textContent = 
                    new Date().toLocaleString('pt-BR');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar embarques:', error);
                throw error;
            }
        }
        
        // Fun√ß√£o JSONP para compatibilidade com Google Apps Script
        function fazerRequisicaoJSONP(url, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Criar fun√ß√£o callback global tempor√°ria
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                // Adicionar callback aos par√¢metros
                const urlParams = new URLSearchParams(params);
                urlParams.append('callback', callbackName);
                
                // Criar script tag
                const script = document.createElement('script');
                script.src = url + '?' + urlParams.toString();
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Falha na requisi√ß√£o JSONP'));
                };
                
                // Timeout
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('Timeout na requisi√ß√£o JSONP'));
                    }
                }, 30000);
                
                document.body.appendChild(script);
            });
        }
        
        // ================================================================================
        // PROCESSAMENTO DE DASHBOARDS
        // ================================================================================
        
        function processarDashboards() {
            console.log('‚öôÔ∏è Processando dashboards...');
            console.log('üìä Total de embarques recebidos:', dadosEmbarques.length);
            
            // Verificar se h√° dados v√°lidos
            if (!Array.isArray(dadosEmbarques) || dadosEmbarques.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum dado de embarque dispon√≠vel');
                mostrarEmptyStates();
                return;
            }
            
            // Resetar dados filtrados
            dadosFiltrados = {
                conferencias: [],
                checkins: [],
                posVendas: []
            };
            
            // Processar confer√™ncias (agrupadas por informe)
            processarConferencias();
            console.log('‚úÖ Confer√™ncias processadas:', dadosFiltrados.conferencias.length);
            
            // Processar check-ins (individuais por voo)
            processarCheckins();
            console.log('‚úÖ Check-ins processados:', dadosFiltrados.checkins.length);
            
            // Processar p√≥s-vendas (agrupadas, ativadas por data)
            processarPosVendas();
            console.log('‚úÖ P√≥s-vendas processadas:', dadosFiltrados.posVendas.length);
            
            // Renderizar dashboards
            renderizarDashboards();
        }
        
        function mostrarEmptyStates() {
            // Mostrar estados vazios em todos os dashboards
            document.getElementById('conferenciasContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <p>Conectando com a planilha...</p>
                    <small>Verifique sua conex√£o com a internet</small>
                </div>
            `;
            
            document.getElementById('checkinsContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-plane-departure"></i>
                    <p>Conectando com a planilha...</p>
                    <small>Verifique sua conex√£o com a internet</small>
                </div>
            `;
            
            document.getElementById('posVendasContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-star"></i>
                    <p>Conectando com a planilha...</p>
                    <small>Verifique sua conex√£o com a internet</small>
                </div>
            `;
            
            // Zerar contadores
            atualizarContadores();
        }
        
        function processarConferencias() {
            const informes = {};
            
            // Agrupar por n√∫mero do informe
            dadosEmbarques.forEach(embarque => {
                if (!embarque.numeroInforme || embarque.conferenciaFeita) return;
                
                if (!informes[embarque.numeroInforme]) {
                    informes[embarque.numeroInforme] = {
                        numeroInforme: embarque.numeroInforme,
                        vendedor: embarque.vendedor,
                        clientes: new Set(),
                        datas: [],
                        voos: [],
                        cpfPrincipal: embarque.cpfCliente
                    };
                }
                
                const informe = informes[embarque.numeroInforme];
                informe.clientes.add(embarque.nomeCliente);
                informe.datas.push(new Date(embarque.dataIda));
                informe.voos.push(embarque);
            });
            
            // Converter para array e calcular prioridades
            dadosFiltrados.conferencias = Object.values(informes).map(informe => {
                const primeiraData = new Date(Math.min(...informe.datas));
                const diasParaConferencia = calcularDiasRestantes(primeiraData) - 10;
                
                return {
                    ...informe,
                    clientes: Array.from(informe.clientes),
                    primeiraData: primeiraData,
                    diasParaConferencia: diasParaConferencia,
                    prioridade: calcularPrioridadeConferencia(diasParaConferencia),
                    totalVoos: informe.voos.length
                };
            });
            
            // Ordenar por prioridade
            dadosFiltrados.conferencias.sort((a, b) => {
                const ordemPrioridade = { 'ATRASADO': 0, 'URGENTE': 1, 'PROXIMO': 2, 'NORMAL': 3 };
                return ordemPrioridade[a.prioridade] - ordemPrioridade[b.prioridade];
            });
        }
        
        function processarCheckins() {
            dadosFiltrados.checkins = dadosEmbarques.filter(embarque => {
                if (!embarque.dataIda || embarque.checkinFeito) return false;
                
                const dataVoo = new Date(embarque.dataIda);
                const diasParaVoo = calcularDiasRestantes(dataVoo) - 2;
                
                // S√≥ mostrar se est√° dentro da janela de check-in (2 dias antes ou menos)
                return diasParaVoo <= 0;
                
            }).map(embarque => {
                const dataVoo = new Date(embarque.dataIda);
                const diasParaCheckin = calcularDiasRestantes(dataVoo) - 2;
                
                return {
                    ...embarque,
                    diasParaCheckin: diasParaCheckin,
                    prioridade: calcularPrioridadeCheckin(diasParaCheckin)
                };
            });
            
            // Ordenar por prioridade
            dadosFiltrados.checkins.sort((a, b) => {
                const ordemPrioridade = { 'ATRASADO': 0, 'URGENTE': 1, 'PROXIMO': 2, 'NORMAL': 3 };
                return ordemPrioridade[a.prioridade] - ordemPrioridade[b.prioridade];
            });
        }
        
        function processarPosVendas() {
            const informes = {};
            
            // Agrupar por n√∫mero do informe
            dadosEmbarques.forEach(embarque => {
                if (!embarque.numeroInforme || embarque.posVendaFeita) return;
                
                if (!informes[embarque.numeroInforme]) {
                    informes[embarque.numeroInforme] = {
                        numeroInforme: embarque.numeroInforme,
                        vendedor: embarque.vendedor,
                        clientes: new Set(),
                        datasVolta: [],
                        voos: [],
                        cpfPrincipal: embarque.cpfCliente
                    };
                }
                
                const informe = informes[embarque.numeroInforme];
                informe.clientes.add(embarque.nomeCliente);
                
                // Considerar tanto data de volta quanto data de ida (para voos s√≥ de ida)
                if (embarque.dataVolta) {
                    informe.datasVolta.push(new Date(embarque.dataVolta));
                } else {
                    informe.datasVolta.push(new Date(embarque.dataIda));
                }
                
                informe.voos.push(embarque);
            });
            
            // Converter para array e filtrar por data
            dadosFiltrados.posVendas = Object.values(informes).filter(informe => {
                const ultimaData = new Date(Math.max(...informe.datasVolta));
                const diasAposRetorno = calcularDiasPassados(ultimaData);
                
                // Ativar p√≥s-venda 1 dia ap√≥s o retorno
                return diasAposRetorno >= 1;
                
            }).map(informe => {
                const ultimaData = new Date(Math.max(...informe.datasVolta));
                const diasAposRetorno = calcularDiasPassados(ultimaData);
                
                return {
                    ...informe,
                    clientes: Array.from(informe.clientes),
                    ultimaData: ultimaData,
                    diasAposRetorno: diasAposRetorno,
                    prioridade: 'NORMAL', // P√≥s-venda n√£o tem urg√™ncia cr√≠tica
                    totalVoos: informe.voos.length
                };
            });
            
            // Ordenar por data (mais antigos primeiro)
            dadosFiltrados.posVendas.sort((a, b) => b.diasAposRetorno - a.diasAposRetorno);
        }
        
        // ================================================================================
        // C√ÅLCULO DE PRIORIDADES
        // ================================================================================
        
        function calcularPrioridadeConferencia(diasRestantes) {
            if (diasRestantes <= -1) return 'ATRASADO';
            if (diasRestantes <= 0) return 'URGENTE';
            if (diasRestantes <= 3) return 'PROXIMO';
            return 'NORMAL';
        }
        
        function calcularPrioridadeCheckin(diasRestantes) {
            if (diasRestantes <= -1) return 'ATRASADO';
            if (diasRestantes <= 0) return 'URGENTE';
            if (diasRestantes <= 1) return 'PROXIMO';
            return 'NORMAL';
        }
        
        function calcularDiasRestantes(dataFutura) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const dataAlvo = new Date(dataFutura);
            dataAlvo.setHours(0, 0, 0, 0);
            
            const diffTime = dataAlvo.getTime() - hoje.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        function calcularDiasPassados(dataPassada) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const dataAlvo = new Date(dataPassada);
            dataAlvo.setHours(0, 0, 0, 0);
            
            const diffTime = hoje.getTime() - dataAlvo.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // ================================================================================
        // RENDERIZA√á√ÉO DE DASHBOARDS
        // ================================================================================
        
        function renderizarDashboards() {
            renderizarConferencias();
            renderizarCheckins();
            renderizarPosVendas();
            atualizarContadores();
        }
        
        function renderizarConferencias() {
            const container = document.getElementById('conferenciasContent');
            const conferencias = aplicarFiltrosLista(dadosFiltrados.conferencias);
            
            if (conferencias.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>Nenhuma confer√™ncia pendente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = conferencias.map(informe => `
                <div class="embarque-card priority-${informe.prioridade}" 
                     onclick="abrirModalConferencia('${informe.numeroInforme}')">
                    <div class="card-header-custom">
                        <span class="priority-badge ${informe.prioridade}">${informe.prioridade}</span>
                        <span class="days-remaining">${formatarDiasRestantes(informe.diasParaConferencia)}</span>
                    </div>
                    <div class="card-info">
                        <strong>Informe:</strong> ${informe.numeroInforme}
                    </div>
                    <div class="card-info">
                        <strong>Vendedor:</strong> ${informe.vendedor}
                    </div>
                    <div class="card-info">
                        <strong>Cliente:</strong> ${informe.clientes[0]}
                        ${informe.clientes.length > 1 ? ` (+${informe.clientes.length - 1})` : ''}
                    </div>
                    <div class="card-info">
                        <strong>Primeira viagem:</strong> ${formatarData(informe.primeiraData)}
                    </div>
                    <div class="card-info">
                        <strong>Total de voos:</strong> ${informe.totalVoos}
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-conferencia" onclick="event.stopPropagation(); abrirModalConferencia('${informe.numeroInforme}')">
                            <i class="fas fa-check"></i> Conferir
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderizarCheckins() {
            const container = document.getElementById('checkinsContent');
            const checkins = aplicarFiltrosLista(dadosFiltrados.checkins);
            
            if (checkins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plane-departure"></i>
                        <p>Nenhum check-in pendente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = checkins.map(voo => `
                <div class="embarque-card priority-${voo.prioridade}" 
                     onclick="abrirModalCheckin('${voo.id}')">
                    <div class="card-header-custom">
                        <span class="priority-badge ${voo.prioridade}">${voo.prioridade}</span>
                        <span class="days-remaining">${formatarDiasRestantes(voo.diasParaCheckin)}</span>
                    </div>
                    <div class="card-info">
                        <strong>Cliente:</strong> ${voo.nomeCliente}
                    </div>
                    <div class="card-info">
                        <strong>Data do voo:</strong> ${formatarData(voo.dataIda)}
                    </div>
                    <div class="card-info">
                        <strong>Companhia:</strong> ${voo.cia || 'N/A'}
                    </div>
                    <div class="card-info">
                        <strong>Tipo:</strong> ${voo.tipoAereo || voo.tipo}
                    </div>
                    <div class="card-info">
                        <strong>Vendedor:</strong> ${voo.vendedor}
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-checkin" onclick="event.stopPropagation(); abrirModalCheckin('${voo.id}')">
                            <i class="fas fa-plane-departure"></i> Check-in
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderizarPosVendas() {
            const container = document.getElementById('posVendasContent');
            const posVendas = aplicarFiltrosLista(dadosFiltrados.posVendas);
            
            if (posVendas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <p>Nenhuma p√≥s-venda pendente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posVendas.map(informe => `
                <div class="embarque-card priority-${informe.prioridade}" 
                     onclick="abrirModalPosVenda('${informe.numeroInforme}')">
                    <div class="card-header-custom">
                        <span class="priority-badge ${informe.prioridade}">DISPON√çVEL</span>
                        <span class="days-remaining">+${informe.diasAposRetorno} dias</span>
                    </div>
                    <div class="card-info">
                        <strong>Informe:</strong> ${informe.numeroInforme}
                    </div>
                    <div class="card-info">
                        <strong>Cliente:</strong> ${informe.clientes[0]}
                        ${informe.clientes.length > 1 ? ` (+${informe.clientes.length - 1})` : ''}
                    </div>
                    <div class="card-info">
                        <strong>Retorno:</strong> ${formatarData(informe.ultimaData)}
                    </div>
                    <div class="card-info">
                        <strong>Vendedor:</strong> ${informe.vendedor}
                    </div>
                    <div class="card-info">
                        <strong>Total de voos:</strong> ${informe.totalVoos}
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-pos-venda" onclick="event.stopPropagation(); abrirModalPosVenda('${informe.numeroInforme}')">
                            <i class="fas fa-star"></i> P√≥s-venda
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ================================================================================
        // FILTROS
        // ================================================================================
        
        function aplicarFiltros() {
            filtrosAtivos.vendedor = document.getElementById('filtroVendedor').value;
            filtrosAtivos.prioridade = document.getElementById('filtroPrioridade').value;
            filtrosAtivos.cliente = document.getElementById('buscaCliente').value.toLowerCase();
            
            renderizarDashboards();
        }
        
        function aplicarFiltrosLista(lista) {
            return lista.filter(item => {
                // Filtro por vendedor
                if (filtrosAtivos.vendedor && item.vendedor !== filtrosAtivos.vendedor) {
                    return false;
                }
                
                // Filtro por prioridade
                if (filtrosAtivos.prioridade && item.prioridade !== filtrosAtivos.prioridade) {
                    return false;
                }
                
                // Filtro por cliente
                if (filtrosAtivos.cliente) {
                    const clientes = Array.isArray(item.clientes) ? item.clientes : [item.nomeCliente];
                    const clienteMatch = clientes.some(cliente => 
                        cliente.toLowerCase().includes(filtrosAtivos.cliente)
                    );
                    
                    const cpfMatch = item.cpfPrincipal && 
                        item.cpfPrincipal.replace(/\D/g, '').includes(filtrosAtivos.cliente.replace(/\D/g, ''));
                    
                    if (!clienteMatch && !cpfMatch) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // ================================================================================
        // MODAIS E A√á√ïES
        // ================================================================================
        
        function abrirModalConferencia(numeroInforme) {
            const informe = dadosFiltrados.conferencias.find(i => i.numeroInforme === numeroInforme);
            if (!informe) return;
            
            modalData.conferencia = informe;
            
            document.getElementById('conferencia-info').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>N√∫mero do Informe:</strong> ${informe.numeroInforme}</p>
                        <p><strong>Vendedor:</strong> ${informe.vendedor}</p>
                        <p><strong>Primeira Data:</strong> ${formatarData(informe.primeiraData)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total de Voos:</strong> ${informe.totalVoos}</p>
                        <p><strong>Clientes:</strong> ${informe.clientes.join(', ')}</p>
                        <p><strong>Status:</strong> <span class="priority-badge ${informe.prioridade}">${informe.prioridade}</span></p>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('modalConferencia')).show();
        }
        
        async function confirmarConferencia() {
            try {
                const informe = modalData.conferencia;
                
                const dados = {
                    action: 'marcar_conferencia',
                    cpf: informe.cpfPrincipal,
                    numeroInforme: informe.numeroInforme,
                    desfazer: false
                };
                
                const response = await enviarAcao(dados);
                
                if (response.success) {
                    mostrarAlerta('Confer√™ncia marcada com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalConferencia')).hide();
                    await carregarEmbarques();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar confer√™ncia:', error);
                mostrarAlerta('Erro ao marcar confer√™ncia: ' + error.message, 'danger');
            }
        }
        
        function abrirModalCheckin(vooId) {
            const voo = dadosFiltrados.checkins.find(v => v.id == vooId);
            if (!voo) return;
            
            modalData.checkin = voo;
            
            document.getElementById('checkin-info').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Cliente:</strong> ${voo.nomeCliente}</p>
                        <p><strong>CPF:</strong> ${voo.cpfCliente}</p>
                        <p><strong>Data do Voo:</strong> ${formatarData(voo.dataIda)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Companhia:</strong> ${voo.cia || 'N/A'}</p>
                        <p><strong>Tipo:</strong> ${voo.tipoAereo || voo.tipo}</p>
                        <p><strong>Status:</strong> <span class="priority-badge ${voo.prioridade}">${voo.prioridade}</span></p>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('modalCheckin')).show();
        }
        
        async function confirmarCheckin() {
            try {
                const voo = modalData.checkin;
                
                const dados = {
                    action: 'marcar_checkin',
                    cpf: voo.cpfCliente,
                    recibo: voo.recibo,
                    dataVoo: formatarDataAPI(voo.dataIda),
                    desfazer: false
                };
                
                const response = await enviarAcao(dados);
                
                if (response.success) {
                    mostrarAlerta('Check-in marcado com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalCheckin')).hide();
                    await carregarEmbarques();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar check-in:', error);
                mostrarAlerta('Erro ao marcar check-in: ' + error.message, 'danger');
            }
        }
        
        function abrirModalPosVenda(numeroInforme) {
            const informe = dadosFiltrados.posVendas.find(i => i.numeroInforme === numeroInforme);
            if (!informe) return;
            
            modalData.posVenda = informe;
            
            document.getElementById('pos-venda-info').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>N√∫mero do Informe:</strong> ${informe.numeroInforme}</p>
                        <p><strong>Vendedor:</strong> ${informe.vendedor}</p>
                        <p><strong>Data de Retorno:</strong> ${formatarData(informe.ultimaData)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total de Voos:</strong> ${informe.totalVoos}</p>
                        <p><strong>Clientes:</strong> ${informe.clientes.join(', ')}</p>
                        <p><strong>Dias ap√≥s retorno:</strong> ${informe.diasAposRetorno}</p>
                    </div>
                </div>
            `;
            
            // Limpar formul√°rio
            document.getElementById('formPosVenda').reset();
            
            new bootstrap.Modal(document.getElementById('modalPosVenda')).show();
        }
        
        async function confirmarPosVenda() {
            try {
                const informe = modalData.posVenda;
                
                const dadosEditaveis = {
                    observacoes: document.getElementById('observacoes').value,
                    grupoOfertas: document.getElementById('grupoOfertas').value,
                    postouInsta: document.getElementById('postouInsta').value,
                    avaliacaoGoogle: document.getElementById('avaliacaoGoogle').value,
                    sac: document.getElementById('sac').value,
                    numeroSAC: document.getElementById('numeroSAC').value
                };
                
                const dados = {
                    action: 'marcar_pos_venda',
                    cpf: informe.cpfPrincipal,
                    numeroInforme: informe.numeroInforme,
                    dadosEditaveis: JSON.stringify(dadosEditaveis),
                    desfazer: false
                };
                
                const response = await enviarAcao(dados);
                
                if (response.success) {
                    mostrarAlerta('P√≥s-venda marcada com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalPosVenda')).hide();
                    await carregarEmbarques();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar p√≥s-venda:', error);
                mostrarAlerta('Erro ao marcar p√≥s-venda: ' + error.message, 'danger');
            }
        }
        
        // ================================================================================
        // UTILIT√ÅRIOS E API
        // ================================================================================
        
        async function enviarAcao(dados) {
            try {
                // Para a√ß√µes POST, usar formul√°rio oculto como o modelo antigo
                return await fazerRequisicaoPOST(CVC_CONFIG.API_URL, dados);
            } catch (error) {
                console.error('‚ùå Erro na a√ß√£o:', error);
                throw error;
            }
        }
        
        // Fun√ß√£o para enviar POST via formul√°rio (compat√≠vel com Google Apps Script)
        function fazerRequisicaoPOST(url, dados) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_post_' + Math.round(100000 * Math.random());
                
                // Criar fun√ß√£o callback global tempor√°ria
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    resolve(data);
                };
                
                // Adicionar callback aos dados
                dados.callback = callbackName;
                
                // Criar formul√°rio oculto
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = url;
                form.target = callbackName + '_iframe';
                form.style.display = 'none';
                
                // Adicionar campos do formul√°rio
                Object.keys(dados).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = typeof dados[key] === 'object' ? JSON.stringify(dados[key]) : dados[key];
                    form.appendChild(input);
                });
                
                // Criar iframe oculto para receber resposta
                const iframe = document.createElement('iframe');
                iframe.name = callbackName + '_iframe';
                iframe.style.display = 'none';
                
                // Usar JSONP para POST
                const script = document.createElement('script');
                const urlParams = new URLSearchParams();
                Object.keys(dados).forEach(key => {
                    urlParams.append(key, typeof dados[key] === 'object' ? JSON.stringify(dados[key]) : dados[key]);
                });
                script.src = url + '?' + urlParams.toString();
                
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Falha na requisi√ß√£o POST'));
                };
                
                // Timeout
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) document.body.removeChild(script);
                        reject(new Error('Timeout na requisi√ß√£o POST'));
                    }
                }, 30000);
                
                document.body.appendChild(script);
            });
        }
        
        function atualizarContadores() {
            document.getElementById('contadorConferencias').textContent = 
                aplicarFiltrosLista(dadosFiltrados.conferencias).length;
            
            document.getElementById('contadorCheckins').textContent = 
                aplicarFiltrosLista(dadosFiltrados.checkins).length;
            
            document.getElementById('contadorPosVendas').textContent = 
                aplicarFiltrosLista(dadosFiltrados.posVendas).length;
        }
        
        function configurarAutoRefresh() {
            setInterval(async () => {
                try {
                    await carregarEmbarques();
                    console.log('üîÑ Auto-refresh executado');
                } catch (error) {
                    console.error('‚ùå Erro no auto-refresh:', error);
                }
            }, 5 * 60 * 1000); // 5 minutos
        }
        
        // Fun√ß√µes de formata√ß√£o
        function formatarData(data) {
            if (!data) return 'N/A';
            return new Date(data).toLocaleDateString('pt-BR');
        }
        
        function formatarDataAPI(data) {
            if (!data) return '';
            return new Date(data).toISOString().split('T')[0];
        }
        
        function formatarDiasRestantes(dias) {
            if (dias < 0) {
                return `${Math.abs(dias)} dia(s) atr√°s`;
            } else if (dias === 0) {
                return 'Hoje';
            } else {
                return `${dias} dia(s)`;
            }
        }
        
        // Fun√ß√µes de interface
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarAlerta(mensagem, tipo) {
            const container = document.getElementById('alertContainer');
            const alertClass = tipo === 'success' ? 'alert-success-custom' : 'alert-danger-custom';
            
            container.innerHTML = `
                <div class="alert alert-custom ${alertClass} alert-dismissible fade show" role="alert">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    new bootstrap.Alert(alert).close();
                }
            }, 5000);
        }
        
        // Fun√ß√µes de navega√ß√£o
        function voltarDashboard() {
            window.location.href = 'index.html';
        }
        
        async function recarregarEmbarques() {
            try {
                mostrarLoading(true);
                await carregarEmbarques();
                mostrarAlerta('Embarques atualizados com sucesso!', 'success');
            } catch (error) {
                mostrarAlerta('Erro ao atualizar embarques: ' + error.message, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }
        
        function exportarRelatorio() {
            // TODO: Implementar exporta√ß√£o para Excel/PDF
            mostrarAlerta('Funcionalidade de exporta√ß√£o em desenvolvimento', 'warning');
        }
        
        // Fun√ß√£o de teste de conectividade
        async function testarConectividade() {
            try {
                mostrarLoading(true);
                console.log('üß™ Testando conectividade com a API...');
                
                const dados = await fazerRequisicaoJSONP(CVC_CONFIG.API_URL, {
                    action: 'ping',
                    teste: 'conectividade'
                });
                
                console.log('üì° Resposta do teste:', dados);
                
                if (dados.success) {
                    mostrarAlerta(`‚úÖ API funcionando! Vers√£o: ${dados.versao || 'N/A'}`, 'success');
                } else {
                    mostrarAlerta(`‚ö†Ô∏è API respondeu mas com erro: ${dados.message}`, 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no teste de conectividade:', error);
                mostrarAlerta(`‚ùå Falha na conectividade: ${error.message}`, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }
    </script>
</body>
</html>
